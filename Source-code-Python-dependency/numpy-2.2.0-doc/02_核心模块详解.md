# NumPy 核心模块详解 (_core)

## 1. 概述

`numpy._core` 是 NumPy 的核心实现模块，包含了数组对象、通用函数（ufunc）、数据类型系统等基础功能。

> **注意**: 在 NumPy 2.0 之前，这个模块叫 `numpy.core`。从 2.0 开始改名为 `numpy._core` 以表明这是内部实现，不应该直接使用。

## 2. 模块结构

### 2.1 目录组成

```
_core/
├── __init__.py              # 模块入口
├── multiarray.py            # 多维数组核心功能
├── umath.py                 # 数学通用函数
├── numeric.py               # 数值操作函数
├── numerictypes.py          # 数值类型定义
├── fromnumeric.py           # 从数组方法包装的函数
├── arrayprint.py            # 数组打印格式化
├── einsumfunc.py            # Einstein 求和约定
├── records.py               # 记录数组
├── memmap.py                # 内存映射数组
├── getlimits.py             # 数值类型极限值
├── function_base.py         # 基础函数实现
├── shape_base.py            # 形状操作
├── overrides.py             # 函数重载机制
├── _dtype.py                # dtype 实现
├── _asarray.py              # 数组转换
├── _type_aliases.py         # 类型别名
├── _ufunc_config.py         # ufunc 配置
├── _internal.py             # 内部工具
├── _exceptions.py           # 异常定义
├── _methods.py              # 数组方法
├── defchararray.py          # 字符数组操作
└── src/                     # C/C++ 源代码
    ├── multiarray/          # 多维数组 C 实现
    ├── umath/               # 数学函数 C 实现
    └── npymath/             # 数学库
```

## 3. 核心组件

### 3.1 multiarray (多维数组)

#### 3.1.1 功能概述
`multiarray` 是 NumPy 最核心的 C 扩展模块，实现了：
- `ndarray` 对象及其方法
- 数组创建和销毁
- 索引和切片
- 内存管理
- 迭代器

#### 3.1.2 主要功能

**数组创建函数**:
```python
- array()           # 从数据创建数组
- zeros()           # 创建零数组
- ones()            # 创建全1数组
- empty()           # 创建未初始化数组
- arange()          # 创建范围数组
- linspace()        # 创建等差数列
- logspace()        # 创建等比数列
- eye()             # 创建单位矩阵
- identity()        # 创建单位矩阵
- full()            # 创建填充特定值的数组
```

**数组转换函数**:
```python
- asarray()         # 转换为数组
- asanyarray()      # 转换为数组（保留子类）
- ascontiguousarray()  # 转换为连续数组
- asfortranarray()  # 转换为 Fortran 顺序数组
- require()         # 按需求转换数组
```

**形状操作**:
```python
- reshape()         # 改变形状
- ravel()           # 展平
- flatten()         # 展平（拷贝）
- transpose()       # 转置
- swapaxes()        # 交换轴
- moveaxis()        # 移动轴
- rollaxis()        # 滚动轴
```

#### 3.1.3 内部实现细节

**ndarray 内部结构**:
```c
typedef struct PyArrayObject {
    PyObject_HEAD
    char *data;              // 指向数据的指针
    int nd;                  // 维度数
    npy_intp *dimensions;    // 每个维度的大小
    npy_intp *strides;       // 每个维度的步长
    PyObject *base;          // 基础对象（用于视图）
    PyArray_Descr *descr;    // 数据类型描述符
    int flags;               // 数组标志
    PyObject *weakreflist;   // 弱引用列表
} PyArrayObject;
```

**关键概念**:
- **步长（strides）**: 每个维度移动一个元素需要跳过的字节数
- **连续性（contiguous）**: 内存布局方式（C 顺序或 Fortran 顺序）
- **视图（view）**: 不复制数据的数组引用
- **广播（broadcasting）**: 自动扩展形状以进行操作

### 3.2 umath (通用数学函数)

#### 3.2.1 功能概述
`umath` 模块实现了 NumPy 的通用函数（ufunc）机制，提供高效的元素级数学运算。

#### 3.2.2 ufunc 类型

**算术运算**:
```python
add, subtract, multiply, divide, power, mod, floor_divide, true_divide
```

**比较运算**:
```python
equal, not_equal, less, less_equal, greater, greater_equal
```

**逻辑运算**:
```python
logical_and, logical_or, logical_xor, logical_not
```

**位运算**:
```python
bitwise_and, bitwise_or, bitwise_xor, bitwise_not, 
left_shift, right_shift
```

**三角函数**:
```python
sin, cos, tan, arcsin, arccos, arctan, arctan2, 
sinh, cosh, tanh, arcsinh, arccosh, arctanh
```

**指数和对数**:
```python
exp, exp2, expm1, log, log2, log10, log1p, logaddexp, logaddexp2
```

**其他数学函数**:
```python
sqrt, cbrt, square, reciprocal, abs, sign, 
ceil, floor, trunc, rint, round
hypot, maximum, minimum, fmax, fmin, fmod, remainder
```

#### 3.2.3 ufunc 特性

1. **向量化**: 自动应用于数组的每个元素
2. **广播**: 支持不同形状数组的操作
3. **类型转换**: 自动处理不同类型的输入
4. **输出类型**: 智能推断结果类型
5. **性能**: C 实现，高度优化

### 3.3 数值类型系统

#### 3.3.1 基础数据类型

**整数类型**:
```python
int8, int16, int32, int64           # 有符号整数
uint8, uint16, uint32, uint64       # 无符号整数
intp                                # 指针大小整数
```

**浮点类型**:
```python
float16, float32, float64           # IEEE 浮点数
float96, float128                   # 扩展精度（部分平台）
```

**复数类型**:
```python
complex64, complex128, complex256
```

**其他类型**:
```python
bool_                               # 布尔类型
str_, bytes_                        # 字符串类型
object_                             # Python 对象
datetime64, timedelta64             # 日期时间类型
```

#### 3.3.2 dtype 对象

**dtype 的作用**:
- 描述数组元素的类型
- 定义内存布局
- 支持结构化数据

**创建 dtype**:
```python
# 基础类型
np.dtype('int32')
np.dtype(np.float64)

# 结构化类型
dt = np.dtype([('x', 'f4'), ('y', 'f4')])

# 子数组类型
dt = np.dtype([('matrix', 'f8', (3, 3))])
```

### 3.4 numeric.py (数值操作)

#### 3.4.1 核心函数

**数组属性查询**:
```python
shape, size, ndim, dtype, itemsize, nbytes
```

**类型转换**:
```python
astype()            # 类型转换
can_cast()          # 检查是否可转换
promote_types()     # 类型提升
result_type()       # 结果类型推断
```

**数学操作**:
```python
dot()               # 点积
vdot()              # 向量点积  
inner()             # 内积
outer()             # 外积
matmul()            # 矩阵乘法
tensordot()         # 张量点积
einsum()            # Einstein 求和
```

**统计函数**:
```python
sum, mean, std, var, min, max, 
argmin, argmax, median, percentile
```

### 3.5 fromnumeric.py (包装函数)

这个模块将 `ndarray` 的方法包装成独立的函数，例如：

```python
# ndarray 方法
arr.sum()
arr.mean()
arr.reshape(shape)

# fromnumeric 包装的函数
np.sum(arr)
np.mean(arr)
np.reshape(arr, shape)
```

**包装的主要方法**:
```python
all, any, argmax, argmin, argpartition, argsort, 
choose, compress, cumprod, cumsum, diagonal, 
max, mean, min, nonzero, partition, prod, 
ptp, ravel, repeat, reshape, resize, round, 
searchsorted, sort, squeeze, std, sum, swapaxes, 
take, trace, transpose, var
```

### 3.6 einsumfunc.py (Einstein 求和)

#### 3.6.1 einsum 功能

`einsum` 是一个强大的函数，使用 Einstein 求和约定进行张量操作。

**基本语法**:
```python
np.einsum(subscripts, *operands)
```

**示例**:
```python
# 矩阵乘法: C[i,j] = A[i,k] * B[k,j]
C = np.einsum('ik,kj->ij', A, B)

# 点积
result = np.einsum('i,i->', a, b)

# 外积
result = np.einsum('i,j->ij', a, b)

# 批量矩阵乘法
result = np.einsum('bij,bjk->bik', A, B)
```

#### 3.6.2 优化

- 自动优化求值路径
- `einsum_path()` 函数用于查找最优路径
- 支持多种优化策略

### 3.7 arrayprint.py (数组打印)

#### 3.7.1 打印选项

```python
np.set_printoptions(
    precision=8,        # 浮点精度
    threshold=1000,     # 摘要显示阈值
    edgeitems=3,        # 边缘项数
    linewidth=75,       # 行宽
    suppress=False,     # 抑制科学计数法
    nanstr='nan',       # NaN 字符串
    infstr='inf',       # Inf 字符串
    formatter=None      # 自定义格式化器
)
```

#### 3.7.2 格式化函数

```python
array2string()          # 数组转字符串
array_repr()            # 数组的 repr 表示
array_str()             # 数组的 str 表示
format_float_scientific()  # 科学计数法
format_float_positional()  # 位置记数法
```

### 3.8 records.py (记录数组)

#### 3.8.1 记录数组

结构化数组的特殊形式，允许通过字段名访问：

```python
# 创建记录数组
dt = np.dtype([('x', 'f4'), ('y', 'f4'), ('z', 'f4')])
rec = np.recarray((10,), dtype=dt)

# 访问字段
rec.x = 1.0
rec.y = 2.0
```

#### 3.8.2 recarray vs structured array

- `recarray`: 字段可以作为属性访问
- `structured array`: 字段只能通过索引访问

### 3.9 memmap.py (内存映射)

#### 3.9.1 内存映射数组

将磁盘文件映射到内存，用于处理大文件：

```python
# 创建内存映射
fp = np.memmap('data.dat', dtype='float32', mode='w+', shape=(1000, 1000))

# 像普通数组一样使用
fp[0, :] = np.arange(1000)

# 同步到磁盘
fp.flush()
```

#### 3.9.2 优势

- 不需要将整个文件加载到内存
- 支持大于内存的数据集
- 自动分页管理

## 4. 内存布局

### 4.1 C 顺序 vs Fortran 顺序

**C 顺序（行主序）**:
```python
# 最后一个索引变化最快
arr = np.array([[1, 2, 3],
                [4, 5, 6]], order='C')
# 内存: [1, 2, 3, 4, 5, 6]
```

**Fortran 顺序（列主序）**:
```python
# 第一个索引变化最快
arr = np.array([[1, 2, 3],
                [4, 5, 6]], order='F')
# 内存: [1, 4, 2, 5, 3, 6]
```

### 4.2 步长（Strides）

步长定义了在每个维度上移动一个元素需要跳过的字节数：

```python
arr = np.array([[1, 2, 3],
                [4, 5, 6]])
print(arr.strides)  # (24, 8) for int64
# 第一维步长: 24 字节（3个int64）
# 第二维步长: 8 字节（1个int64）
```

### 4.3 视图与拷贝

**视图操作**（不复制数据）:
```python
- 基础切片: arr[1:3]
- reshape（某些情况）
- transpose, swapaxes
- ravel（某些情况）
```

**拷贝操作**（创建新数据）:
```python
- arr.copy()
- 花式索引: arr[[1, 2, 3]]
- 布尔索引: arr[arr > 0]
- flatten()
```

## 5. 性能优化

### 5.1 向量化

避免 Python 循环，使用 NumPy 的向量化操作：

```python
# 慢（Python 循环）
result = []
for i in range(len(a)):
    result.append(a[i] + b[i])

# 快（向量化）
result = a + b
```

### 5.2 广播

利用广播避免不必要的数组复制：

```python
# 低效
a = np.ones((1000, 1000))
b = np.arange(1000)
b_expanded = np.tile(b, (1000, 1))
result = a + b_expanded

# 高效（使用广播）
result = a + b
```

### 5.3 内存连续性

连续的内存布局提高缓存效率：

```python
# 检查连续性
arr.flags['C_CONTIGUOUS']
arr.flags['F_CONTIGUOUS']

# 转换为连续数组
arr_c = np.ascontiguousarray(arr)
arr_f = np.asfortranarray(arr)
```

## 6. C API

### 6.1 主要头文件

```c
#include <numpy/arrayobject.h>    // 数组对象 API
#include <numpy/ufuncobject.h>    // ufunc API
#include <numpy/npy_math.h>       // 数学函数
```

### 6.2 核心 API 分类

**数组创建**:
- `PyArray_SimpleNew()`
- `PyArray_ZEROS()`
- `PyArray_FromAny()`

**数组访问**:
- `PyArray_DATA()`
- `PyArray_GETPTR1/2/3()`
- `PyArray_ITER_NEXT()`

**类型转换**:
- `PyArray_Cast()`
- `PyArray_CanCastSafely()`

## 7. 与用户层的关系

虽然 `_core` 是内部模块，但其功能都通过主命名空间暴露：

```python
# 不应该这样做
from numpy._core import multiarray

# 应该这样做
import numpy as np
np.array()  # 实际调用 _core.multiarray.array
```

## 8. 总结

`numpy._core` 模块是 NumPy 的基石，提供了：
1. 高效的多维数组对象（ndarray）
2. 丰富的通用函数（ufunc）
3. 完善的数据类型系统（dtype）
4. 强大的数组操作功能
5. 优化的内存管理

理解这个模块对于深入使用和优化 NumPy 代码至关重要。

---

**相关文档**:
- [03_数值计算模块.md](03_数值计算模块.md)
- [04_数据类型系统.md](04_数据类型系统.md)
- [05_通用函数ufunc.md](05_通用函数ufunc.md)
