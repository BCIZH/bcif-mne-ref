# NumPy 数据类型系统详解

## 1. 概述

NumPy 的类型系统是其高性能的关键，提供了丰富的数值类型、结构化类型和自定义类型支持。

## 2. dtype 对象

### 2.1 什么是 dtype

`dtype` (data type) 描述了数组元素的：
- 数据类型（整数、浮点数、复数等）
- 大小（字节数）
- 字节序（大端或小端）
- 结构化字段（对于结构化类型）
- 子数组形状（对于子数组类型）

### 2.2 创建 dtype

#### 2.2.1 从字符串创建

```python
import numpy as np

# 单字符代码
dt = np.dtype('i')      # 默认整数
dt = np.dtype('f')      # 默认浮点数
dt = np.dtype('c')      # 默认复数
dt = np.dtype('S')      # 字节串
dt = np.dtype('U')      # Unicode 字符串

# 带大小的类型字符串
dt = np.dtype('i4')     # 32位整数
dt = np.dtype('f8')     # 64位浮点数
dt = np.dtype('c16')    # 128位复数

# 完整类型名称
dt = np.dtype('int32')
dt = np.dtype('float64')
dt = np.dtype('complex128')

# 带字节序
dt = np.dtype('<i4')    # 小端 32位整数
dt = np.dtype('>i4')    # 大端 32位整数
dt = np.dtype('=i4')    # 本地字节序
dt = np.dtype('|i1')    # 不关心字节序（单字节）
```

#### 2.2.2 从 NumPy 类型创建

```python
dt = np.dtype(np.int32)
dt = np.dtype(np.float64)
dt = np.dtype(np.complex128)
```

#### 2.2.3 从 Python 类型创建

```python
dt = np.dtype(int)      # 转换为 np.int_
dt = np.dtype(float)    # 转换为 np.float64
dt = np.dtype(complex)  # 转换为 np.complex128
dt = np.dtype(bool)     # 转换为 np.bool_
```

## 3. 基础数据类型

### 3.1 整数类型

#### 3.1.1 有符号整数

| 类型 | 描述 | 范围 | 别名 |
|------|------|------|------|
| `int8` | 8位整数 | -128 到 127 | `i1`, `byte` |
| `int16` | 16位整数 | -32768 到 32767 | `i2`, `short` |
| `int32` | 32位整数 | -2^31 到 2^31-1 | `i4`, `intc` |
| `int64` | 64位整数 | -2^63 到 2^63-1 | `i8`, `longlong` |
| `intp` | 指针大小整数 | 平台相关 | `int_` |

#### 3.1.2 无符号整数

| 类型 | 描述 | 范围 | 别名 |
|------|------|------|------|
| `uint8` | 8位无符号整数 | 0 到 255 | `u1`, `ubyte` |
| `uint16` | 16位无符号整数 | 0 到 65535 | `u2`, `ushort` |
| `uint32` | 32位无符号整数 | 0 到 2^32-1 | `u4`, `uintc` |
| `uint64` | 64位无符号整数 | 0 到 2^64-1 | `u8`, `ulonglong` |
| `uintp` | 指针大小无符号整数 | 平台相关 | `uint` |

**示例**:
```python
# 整数溢出行为（环绕）
arr = np.array([127], dtype=np.int8)
arr += 1
print(arr)  # [-128] 溢出

# 避免溢出
arr = np.array([127], dtype=np.int16)
arr += 1
print(arr)  # [128]
```

### 3.2 浮点类型

| 类型 | 描述 | 精度 | 别名 |
|------|------|------|------|
| `float16` | 半精度浮点 | ~3位十进制 | `f2`, `half` |
| `float32` | 单精度浮点 | ~7位十进制 | `f4`, `single` |
| `float64` | 双精度浮点 | ~16位十进制 | `f8`, `double`, `float_` |
| `float128` | 四精度浮点（部分平台） | ~34位十进制 | `f16`, `longdouble` |

**特殊值**:
```python
np.inf          # 正无穷
-np.inf         # 负无穷
np.nan          # Not a Number

# 检测
np.isinf(x)     # 是否为无穷
np.isnan(x)     # 是否为 NaN
np.isfinite(x)  # 是否为有限数
```

**浮点信息**:
```python
info = np.finfo(np.float64)
print(info.max)         # 最大值
print(info.min)         # 最小值
print(info.eps)         # 机器精度
print(info.resolution)  # 分辨率
print(info.bits)        # 位数
```

### 3.3 复数类型

| 类型 | 描述 | 组成 |
|------|------|------|
| `complex64` | 单精度复数 | 2个 float32 |
| `complex128` | 双精度复数 | 2个 float64 |
| `complex256` | 四精度复数（部分平台） | 2个 float128 |

**操作**:
```python
z = np.array([1+2j, 3+4j], dtype=np.complex128)

# 实部和虚部
real_part = z.real
imag_part = z.imag

# 共轭
z_conj = np.conj(z)

# 绝对值（模）
magnitude = np.abs(z)

# 相位
phase = np.angle(z)
```

### 3.4 布尔类型

```python
dt = np.dtype(np.bool_)

# 布尔运算
a = np.array([True, False, True])
b = np.array([True, True, False])

result = a & b  # 逻辑与
result = a | b  # 逻辑或
result = ~a     # 逻辑非
result = a ^ b  # 逻辑异或
```

### 3.5 字符串类型

#### 3.5.1 字节串 (bytes)

```python
# 固定长度字节串
dt = np.dtype('S10')    # 10字节字符串
arr = np.array([b'hello', b'world'], dtype='S10')

# 别名
dt = np.dtype('a10')    # 'a' 是 'S' 的别名
```

#### 3.5.2 Unicode 字符串

```python
# 固定长度 Unicode 字符串
dt = np.dtype('U10')    # 10个字符的 Unicode 字符串
arr = np.array(['你好', 'world'], dtype='U10')
```

#### 3.5.3 字符串操作

```python
# NumPy 2.0+ 推荐使用 StringDType（实验性）
# 可变长度字符串
from numpy.dtypes import StringDType
dt = StringDType()
```

### 3.6 对象类型

```python
# Python 对象类型（任意 Python 对象）
dt = np.dtype(object)
arr = np.array([{'a': 1}, [1, 2, 3], 'string'], dtype=object)

# 注意：对象数组性能较低，失去了 NumPy 的很多优势
```

### 3.7 日期时间类型

#### 3.7.1 datetime64

```python
# 创建日期时间
dt = np.datetime64('2024-01-15')
dt = np.datetime64('2024-01-15 12:30:00')

# 指定单位
dt = np.datetime64('2024-01-15', 'D')   # 日
dt = np.datetime64('2024-01-15', 'M')   # 月
dt = np.datetime64('2024-01-15', 'Y')   # 年
dt = np.datetime64('12:30:00', 's')     # 秒

# 数组
dates = np.array(['2024-01-01', '2024-01-02'], dtype='datetime64[D]')

# 运算
dates + np.timedelta64(1, 'D')  # 加一天
```

**单位**:
```python
'Y'  # 年
'M'  # 月
'W'  # 周
'D'  # 日
'h'  # 小时
'm'  # 分钟
's'  # 秒
'ms' # 毫秒
'us' # 微秒
'ns' # 纳秒
'ps' # 皮秒
'fs' # 飞秒
'as' # 阿秒
```

#### 3.7.2 timedelta64

```python
# 时间差
td = np.timedelta64(1, 'D')     # 1天
td = np.timedelta64(2, 'h')     # 2小时

# 运算
dt1 = np.datetime64('2024-01-01')
dt2 = np.datetime64('2024-01-10')
diff = dt2 - dt1  # timedelta64[D]
```

### 3.8 void 类型

```python
# 原始字节（未解释的数据）
dt = np.dtype('V10')  # 10字节的 void
```

## 4. 结构化数据类型

### 4.1 基本结构化类型

```python
# 定义结构
dt = np.dtype([
    ('name', 'U10'),
    ('age', 'i4'),
    ('height', 'f4')
])

# 创建数组
data = np.array([
    ('Alice', 25, 165.5),
    ('Bob', 30, 175.0),
    ('Charlie', 35, 180.2)
], dtype=dt)

# 访问字段
names = data['name']
ages = data['age']

# 单个元素
print(data[0]['name'])  # 'Alice'
print(data[0]['age'])   # 25
```

### 4.2 带标题的字段

```python
dt = np.dtype([
    ('name', 'U10', 'Full Name'),
    ('age', 'i4', 'Age in Years'),
])

# 可以通过字段名或标题访问
data = np.zeros(5, dtype=dt)
data['name'] = ...
data['Full Name'] = ...  # 等价
```

### 4.3 嵌套结构

```python
# 嵌套结构
dt = np.dtype([
    ('personal', [
        ('name', 'U20'),
        ('age', 'i4')
    ]),
    ('address', [
        ('street', 'U30'),
        ('city', 'U20')
    ])
])

data = np.zeros(1, dtype=dt)
data[0]['personal']['name'] = 'Alice'
data[0]['address']['city'] = 'Beijing'
```

### 4.4 子数组

```python
# 每个元素包含一个固定大小的数组
dt = np.dtype([
    ('position', 'f4', (3,)),    # 3D 位置向量
    ('velocity', 'f4', (3,)),    # 3D 速度向量
    ('id', 'i4')
])

data = np.zeros(10, dtype=dt)
data[0]['position'] = [1.0, 2.0, 3.0]
data[0]['velocity'] = [0.1, 0.2, 0.3]
```

### 4.5 对齐和填充

```python
# 默认对齐
dt = np.dtype([
    ('a', 'i1'),
    ('b', 'i4')
], align=True)

print(dt.itemsize)  # 可能是 8 而不是 5（因为对齐）

# 查看字段偏移
print(dt.fields)
```

### 4.6 记录数组

```python
# recarray 允许通过属性访问字段
from numpy import recarray

dt = np.dtype([('x', 'f4'), ('y', 'f4')])
rec = np.recarray((10,), dtype=dt)

# 属性访问
rec.x = 1.0
rec.y = 2.0

# 等价于
rec['x'] = 1.0
rec['y'] = 2.0
```

## 5. 类型转换

### 5.1 astype 转换

```python
# 基本转换
arr_int = np.array([1, 2, 3], dtype=np.int32)
arr_float = arr_int.astype(np.float64)

# 转换可能丢失信息
arr_float = np.array([1.1, 2.7, 3.9])
arr_int = arr_float.astype(np.int32)  # [1, 2, 3]

# 字符串转换
arr_str = np.array(['1', '2', '3'])
arr_int = arr_str.astype(np.int32)
```

### 5.2 安全转换检查

```python
# 检查是否可以安全转换
can_convert = np.can_cast(np.float32, np.float64)  # True
can_convert = np.can_cast(np.float64, np.float32)  # False (unsafe)

# 带 casting 参数的转换
# 'no': 不允许任何转换
# 'equiv': 只允许字节序改变
# 'safe': 只允许安全转换
# 'same_kind': 允许同类转换（如 int32 -> int64）
# 'unsafe': 允许任何转换

np.can_cast(np.int32, np.float64, casting='safe')  # True
```

### 5.3 类型提升

```python
# 自动类型提升
result_type = np.promote_types(np.int32, np.float32)
# dtype('float64')

# 结果类型推断
result_type = np.result_type(
    np.array([1, 2], dtype=np.int32),
    np.array([3.0, 4.0], dtype=np.float32)
)
# dtype('float64')
```

### 5.4 通用类型函数

```python
# 查找通用类型
common_type = np.common_type(arr1, arr2, arr3)

# 最小标量类型
min_dtype = np.min_scalar_type(100)  # int8
min_dtype = np.min_scalar_type(1000)  # int16
```

## 6. 类型层次结构

### 6.1 通用类型类

```python
# 类型层次
np.generic
├── np.number
│   ├── np.integer
│   │   ├── np.signedinteger
│   │   │   ├── np.byte
│   │   │   ├── np.short
│   │   │   ├── np.intc
│   │   │   ├── np.int_
│   │   │   └── np.longlong
│   │   └── np.unsignedinteger
│   │       ├── np.ubyte
│   │       ├── np.ushort
│   │       ├── np.uintc
│   │       ├── np.uint
│   │       └── np.ulonglong
│   ├── np.inexact
│   │   ├── np.floating
│   │   │   ├── np.half
│   │   │   ├── np.single
│   │   │   ├── np.double
│   │   │   └── np.longdouble
│   │   └── np.complexfloating
│   │       ├── np.csingle
│   │       ├── np.cdouble
│   │       └── np.clongdouble
├── np.flexible
│   ├── np.character
│   │   ├── np.bytes_
│   │   └── np.str_
│   └── np.void
├── np.bool_
└── np.object_
```

### 6.2 类型检查

```python
# 使用 isinstance
arr = np.array([1, 2, 3])
isinstance(arr.dtype.type, np.integer)  # True
isinstance(arr.dtype.type, np.floating)  # False

# 使用 issubdtype
np.issubdtype(np.int32, np.integer)     # True
np.issubdtype(np.float64, np.integer)   # False
np.issubdtype(np.int32, np.signedinteger)  # True

# NumPy 2.0+ 推荐使用 isdtype
np.isdtype(np.dtype('int32'), np.integer)  # True
```

## 7. 字节序

### 7.1 字节序符号

```python
'<'  # 小端（little-endian）
'>'  # 大端（big-endian）
'='  # 本地字节序
'|'  # 不关心（单字节）
```

### 7.2 检查和转换

```python
# 检查字节序
dt = np.dtype('<i4')
print(dt.byteorder)  # '<'

# 系统字节序
import sys
print(sys.byteorder)  # 'little' 或 'big'

# 转换字节序
arr_little = np.array([1, 2, 3], dtype='<i4')
arr_big = arr_little.astype('>i4')

# 或使用 byteswap
arr_swapped = arr_little.byteswap()
```

## 8. 自定义 dtype

### 8.1 注册自定义标量类型

```python
# NumPy 2.0+ 支持用户自定义 dtype
# 需要继承 np.dtype 并实现必要的方法
# 这是高级主题，通常不需要
```

### 8.2 dtype 元数据

```python
# 添加元数据
dt = np.dtype('f8', metadata={'unit': 'meters'})
print(dt.metadata)  # {'unit': 'meters'}
```

## 9. 内存和性能考虑

### 9.1 内存占用

```python
# 查看 dtype 大小
dt = np.dtype('f8')
print(dt.itemsize)  # 8 字节

# 数组总内存
arr = np.zeros((1000, 1000), dtype='f8')
print(arr.nbytes)  # 8,000,000 字节
```

### 9.2 选择合适的类型

```python
# 节省内存
# 如果数据范围允许，使用较小的类型
arr = np.array([1, 2, 3], dtype=np.int8)  # 而不是 int64

# 精度 vs 内存
# float32 对许多应用足够，占用 float64 一半内存
arr = np.array([1.0, 2.0], dtype=np.float32)
```

### 9.3 对齐和向量化

```python
# 对齐的数据通常性能更好
dt = np.dtype([('a', 'i1'), ('b', 'i4')], align=True)
```

## 10. 常见陷阱

### 10.1 整数溢出

```python
# 默认整数类型取决于平台
arr = np.array([1, 2, 3])  # 可能是 int32 或 int64

# 显式指定类型
arr = np.array([1, 2, 3], dtype=np.int64)

# 溢出
arr = np.array([255], dtype=np.uint8)
arr += 1
print(arr)  # [0] 溢出
```

### 10.2 浮点精度

```python
# 浮点运算不精确
a = np.array([0.1, 0.2, 0.3], dtype=np.float64)
print(a.sum())  # 0.6000000000000001

# 使用 allclose 比较
np.allclose(a.sum(), 0.6)  # True
```

### 10.3 类型转换丢失

```python
# 浮点到整数截断
arr = np.array([1.9, 2.9])
arr_int = arr.astype(np.int32)
print(arr_int)  # [1, 2] 而不是 [2, 3]

# 使用 round
arr_int = np.round(arr).astype(np.int32)
print(arr_int)  # [2, 3]
```

## 11. 总结

NumPy 的类型系统提供了：

1. **丰富的基础类型**: 整数、浮点、复数、布尔、字符串等
2. **结构化类型**: 类似 C 结构体的复合类型
3. **类型安全**: 严格的类型检查和转换规则
4. **性能优化**: 紧凑的内存布局和对齐
5. **灵活性**: 支持自定义类型和元数据

理解 dtype 对于高效使用 NumPy 至关重要。

---

**相关文档**:
- [02_核心模块详解.md](02_核心模块详解.md)
- [05_通用函数ufunc.md](05_通用函数ufunc.md)
- [07_内存管理与性能.md](07_内存管理与性能.md)
