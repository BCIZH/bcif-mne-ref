多设备同步与文件存储格式

想象你要举办一场“多乐器演奏会”（多模态数据采集）：

1. **LSL (Lab Streaming Layer):** 是现场的**调音台和传输线**。它负责把吉他（肌电）、架子鼓（眼动）、键盘（脑电）的声音实时汇集在一起，确保大家拍子是对齐的。  
2. **XDF (.xdf):** 是这场演奏会的**现场多轨录音带**。由于是 LSL 录下来的，它完美保留了所有乐器的同步轨道。  
3. **EDF+ (.edf):** 是最终发行的**CD专辑**。它是通用的、标准的，谁都能播放，但可能不如原始录音带包含那么多技术细节（比如不同采样率的复杂对齐信息已经处理过了）。

---

### **1\. LSL (Lab Streaming Layer) —— 它是“管道”，不是“蓝牙”**

这是你最困惑的地方。**LSL 不替代蓝牙，它接在蓝牙后面。**

#### **你的困惑：**

“数据不是实时通过蓝牙转过来的嘛？为什么还要 LSL？”

#### **答案：**

蓝牙是**硬件到电脑**的物理连接。

LSL 是**电脑内部软件之间**的局域网连接。

**没有 LSL 的痛点：**

* 你的肌电图通过蓝牙发给**软件A**。  
* 你的眼动仪通过 USB 发给**软件B**。  
* 你的刺激程序（比如屏幕上闪烁图片）是**软件C**。  
* **问题：** 软件A、B、C 各跑各的，时间怎么对齐？肌电图里的第 5 秒，对应的是眼动仪的第几秒？很难搞准。

**LSL 的解决方案：**

LSL 在你的电脑内存里建立了一个“局域网广播站”。

1. **硬件层**：肌电手环 \-\> (蓝牙) \-\> 电脑上的 Python 脚本（作为 LSL 发送端）。  
2. **中间层 (LSL)**：这个 Python 脚本把数据打上统一的**高精度时间戳**，扔进 LSL 管道。  
3. **应用层**：你的分析软件、或者一个通用的录制软件（LabRecorder），从 LSL 管道里“收听”数据。

**LSL 最大的价值：** 它是目前解决多设备（眼动+脑电+肌电+鼠标）**时间同步（Time Synchronization）** 的事实标准，误差可以控制在毫秒级。

#### **如何使用 LSL？（开源库与工具）**

\*\*核心库（Python）：`pylsl**`

* **安装：** `pip install pylsl`  
* **使用场景：**  
* 如果你是做硬件接入：你需要写代码把蓝牙收到的数据塞进 `pylsl` 的出口 (Outlet)。  
* 如果你是做数据分析/显示：你需要写代码从 `pylsl` 的入口 (Inlet) 读数据。

**代码示例（极简版）：**

**发送数据（假装从蓝牙读到了数据）：**

from pylsl import StreamInfo, StreamOutlet  
import time  
import random

\# 1\. 创建流信息：名字叫MyEMG，类型EEG，8个通道，100Hz，float32类型  
info \= StreamInfo('MyEMG', 'EEG', 8, 100, 'float32', 'myuid12345')  
outlet \= StreamOutlet(info)

print("正在发送数据...")  
while True:  
    \# 2\. 模拟从蓝牙拿到一组数据 sample  
    sample \= \[random.random() for \_ in range(8)\]  
    \# 3\. 推送到 LSL 网络  
    outlet.push\_sample(sample)  
    time.sleep(0.01)

**接收数据（你的分析软件）：**

from pylsl import StreamInlet, resolve\_stream

\# 1\. 寻找网络里的 EEG 流  
print("正在寻找流...")  
streams \= resolve\_stream('type', 'EEG')  
inlet \= StreamInlet(streams\[0\])

while True:  
    \# 2\. 实时拉取数据  
    sample, timestamp \= inlet.pull\_sample()  
    print(f"收到数据: {sample}, 时间戳: {timestamp}")  
---

### **2\. XDF (.xdf) —— LSL 的亲儿子**

* **是什么：** 它是专门为了存 LSL 数据流而设计的文件格式。  
* **开源库：** `pyxdf`  
* **安装：** `pip install pyxdf`  
* **功能：** 读取 .xdf 文件。  
* **MNE 支持：** MNE-Python 也可以通过 `mne.io.read_raw_xdf` 读取（底层其实调用的就是 pyxdf）。  
* **怎么生成 XDF？**  
* 你不需要自己写代码生成 XDF。  
* **神器推荐：LabRecorder**。这是 LSL 官方提供的免费软件。你只要运行它，它会自动扫描电脑里所有的 LSL 流（肌电、眼动等），你点一下“Start”，它就把所有数据同步录制成一个 `.xdf` 文件。

---

### **3\. EDF+ (.edf) —— 国际通用的老大哥**

* **是什么：** 医疗和科研最通用的标准格式。  
* **开源库：**  
* **MNE-Python (`mne`):** 最推荐。功能最强，支持读写。  
* **PyEDFlib (`pyedflib`):** 轻量级，专门读写 EDF，不包含复杂的脑电分析功能。  
* **如何转换：**  
* 通常流程是：用 LabRecorder 录制成 `.xdf` \-\> 用 MNE 读取 `.xdf` \-\> 用 MNE 导出为 `.edf`。

---

### **总结：你的开发路线图**

如果你要做非侵入式多模态（肌电+眼动）系统，建议的技术栈如下：

1. **数据采集层 (实时)：**  
* **硬件接口：** 使用 Python 的 `pylsl` 库。  
* **逻辑：** 你的程序通过蓝牙读取硬件数据 \-\> 立即通过 `StreamOutlet` 广播出去。  
1. **数据录制层 (存储)：**  
* **方案 A (省事)：** 直接集成或让用户下载 **LabRecorder** (LSL官方应用)，录制生成 `.xdf`。  
* **方案 B (自定义)：** 用 Python `pylsl` 接收数据，自己存文件。但要自己处理时间戳对齐，很麻烦。建议用方案 A。  
1. **数据导出层 (格式转换)：**  
* 用户录完 `.xdf` 后，你的软件使用 `mne` 库读取它，然后提供一个按钮：“导出为标准 EDF+”。  
* **Python 代码：** `raw = mne.io.read_raw_xdf('data.xdf'); raw.export('data.edf', fmt='edf')`

这样你既解决了**多设备同步**（利用 LSL/XDF），又解决了**国际标准兼容**（导出 EDF+）。

