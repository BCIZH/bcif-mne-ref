# Brainstorm3 源估计算法详解

## 概述

源估计（Source Estimation）或称源重建（Source Reconstruction），是MEG/EEG分析的核心步骤，目标是从头皮记录反推大脑内部的电活动源。Brainstorm3 提供20+个源估计相关的处理函数。

## 1. 逆问题基础

### 1.1 正向问题

给定源分布 S，计算传感器测量值 M：

```
M = G × S + n
```

其中：
- M: 测量数据 [nChannels × nTime]
- G: 增益矩阵（导联场矩阵）[nChannels × 3*nSources]
- S: 源活动 [3*nSources × nTime]
- n: 噪声

### 1.2 逆问题

已知 M 和 G，求解 S。这是**欠定问题**（未知数多于方程），需要正则化。

---

## 2. 核心算法 (process_inverse.m)

### 2.1 最小范数估计 (MNE/wMNE)

**原理：**
寻找能量最小的源分布。

**目标函数：**
```matlab
min ||M - G*S||² + λ ||L*S||²
```

其中：
- λ: 正则化参数（SNR的函数）
- L: 正则化矩阵（通常为单位矩阵或深度加权矩阵）

**解析解：**
```matlab
S = W * M
W = L^(-2) * G' * (G*L^(-2)*G' + λ*C_noise)^(-1)
```

**深度加权（wMNE）：**
补偿深部源信号衰减：

```matlab
L = diag(||G(:,i)||^α)  % α通常取0.5
```

**参数说明：**

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| InverseMethod | 选项 | 'wmne' | 最小范数估计 |
| SNR | float | 3 | 信噪比 |
| diagnoise | 布尔 | 0 | 仅使用对角噪声协方差 |
| SourceOrient | 选项 | 'fixed' | 固定/松弛/自由方向 |
| loose | float | 0.2 | 松弛方向约束 (0-1) |
| depth | float | 1 | 深度加权指数 |
| weightexp | float | 0.5 | 权重指数 |
| weightlimit | float | 10 | 权重限制 |

**使用示例：**

```matlab
% 基本wMNE
sFiles = bst_process('CallProcess', 'process_inverse', sFiles, [], ...
    'method',       1, ...         % wMNE
    'sensortypes',  'MEG, EEG', ...
    'output',       1, ...         % Kernel only: shared
    'wmne', struct(...
        'SNR',           3, ...
        'SourceOrient',  {{'fixed'}}, ...
        'depth',         1, ...
        'weightexp',     0.5));
```

---

### 2.2 动态统计参数映射 (dSPM)

**原理：**
标准化MNE结果，提供统计显著性。

**计算：**
```matlab
dSPM(i,t) = S(i,t) / std(S(i,:))
```

其中标准差从噪声协方差估计：
```matlab
std(S(i,:)) = sqrt(W(i,:) * C_noise * W(i,:)')
```

**优点：**
- 提供类似t统计量的值
- 便于阈值化和统计推断
- 单位归一化

**使用示例：**

```matlab
sFiles = bst_process('CallProcess', 'process_inverse', sFiles, [], ...
    'method', 2, ...  % dSPM
    'output', 3);     % Full results
```

---

### 2.3 标准化低分辨率脑电磁断层成像 (sLORETA)

**原理：**
理论上具有零定位误差（对点源）。

**标准化：**
```matlab
sLORETA(i,t) = S(i,t) / sqrt(Resolution(i,i))
```

其中分辨率矩阵：
```matlab
Resolution = W * G
```

**特点：**
- 理论上无偏
- 适合定位孤立源
- 对噪声敏感

**使用示例：**

```matlab
sFiles = bst_process('CallProcess', 'process_inverse', sFiles, [], ...
    'method', 3);  % sLORETA
```

---

### 2.4 方法对比

| 方法 | 定位精度 | 空间分辨率 | 噪声敏感度 | 适用场景 |
|------|----------|-----------|-----------|----------|
| **MNE** | 中 | 弥散 | 低 | 分布源，稳健估计 |
| **wMNE** | 中-高 | 中等 | 中 | 标准选择 |
| **dSPM** | 中-高 | 中等 | 中 | 统计推断 |
| **sLORETA** | 高 | 较差 | 高 | 孤立源定位 |

---

## 3. 波束形成器算法

### 3.1 线性约束最小方差 (LCMV)

**原理：**
在保持目标源增益为1的约束下，最小化输出方差。

**空间滤波器：**
```matlab
W(r) = (C^(-1) * g(r)) / (g(r)' * C^(-1) * g(r))
```

其中：
- C: 数据协方差矩阵 = M*M'/nTime
- g(r): 位置r的导联场向量

**源活动：**
```matlab
S(r,t) = W(r)' * M(:,t)
```

**源功率：**
```matlab
Power(r) = W(r)' * C * W(r)
```

**特点：**
- 自适应（数据驱动）
- 空间分辨率高
- 需要足够数据估计协方差
- 对相关源敏感

**使用场景：**
- 频域分析
- 静息态连接性
- 振荡活动定位

---

### 3.2 合成孔径磁强计 (SAM)

SAM是LCMV在频域的应用。

**伪Z统计量：**
```matlab
pseudo-Z(r) = (Power_active(r) - Power_baseline(r)) / Power_baseline(r)
```

**使用示例：**

```matlab
% 通常需要先计算时频
sFiles_tf = bst_process('CallProcess', 'process_timefreq', sFiles, []);

% 然后应用波束形成器（通过FieldTrip插件）
sFiles = bst_process('CallProcess', 'process_ft_sourceanalysis', sFiles_tf, [], ...
    'method', 'lcmv');
```

---

## 4. 偶极子拟合

### 4.1 等效电流偶极子 (ECD, process_dipole_scanning.m)

**原理：**
假设有限个点源，通过非线性优化拟合位置、方向和强度。

**目标函数：**
```matlab
min ||M - G(r,q)*s||²
```

优化变量：
- r: 偶极子位置 [x, y, z]
- q: 偶极子方向 [qx, qy, qz]
- s: 偶极子强度时间序列

**两步法：**
1. **扫描阶段**：在网格上计算拟合优度
   ```matlab
   GOF(r) = 1 - ||M - G(r)*s_opt||² / ||M||²
   ```

2. **精细化**：从最佳位置开始非线性优化

**参数：**

| 参数 | 说明 |
|------|------|
| Time window | 拟合时间窗口 |
| Number of dipoles | 偶极子数量 (1-4) |

**使用示例：**

```matlab
% 单偶极子扫描
sFiles = bst_process('CallProcess', 'process_dipole_scanning', sFiles, [], ...
    'timewindow', [0.08, 0.12], ...  % 峰值时间窗
    'ndipoles',   1);
```

**适用场景：**
- 明确的孤立成分（如N100, P300）
- 癫痫棘波定位
- 验证分布源结果

**优缺点：**
- ✓ 直观的物理解释
- ✓ 参数少，易于理解
- ✗ 假设点源（实际可能是扩展源）
- ✗ 非线性优化可能陷入局部最优

---

## 5. 源空间定义

### 5.1 体积源空间

**网格类型：**
1. **规则网格**：3D立方体网格
2. **皮层约束网格**：仅在灰质

**参数：**
- Grid resolution: 5-10 mm典型

### 5.2 表面源空间

**优点：**
- 生理合理（皮层源假设）
- 减少未知数
- 提高空间分辨率

**网格密度：**
- 低分辨率：~5,000 顶点
- 中分辨率：~15,000 顶点
- 高分辨率：~100,000 顶点

---

## 6. 源方向约束

### 6.1 固定方向 (Fixed)

假设源垂直于皮层表面。

```matlab
S(i,t) = s_i(t) * n_i  % n_i: 法向量
```

**优点：**
- 减少未知数（3倍）
- 生理合理
- 提高SNR

**使用：**
```matlab
'SourceOrient', {{'fixed'}}
```

---

### 6.2 自由方向 (Free/Unconstr)

三个方向分量独立估计。

```matlab
S(i,t) = [s_x(i,t), s_y(i,t), s_z(i,t)]
```

**优点：**
- 无假设
- 适用于体积源

**缺点：**
- 更多未知数
- 可能不稳定

```matlab
'SourceOrient', {{'unconstr'}}
```

---

### 6.3 松弛方向 (Loose)

折中方案：主要沿法向，允许少量切向成分。

```matlab
L = diag([α, α, 1])  % α < 1 (如0.2)
```

```matlab
'SourceOrient', {{'loose'}}, ...
'loose',        0.2
```

---

## 7. 完整工作流程

### 7.1 准备阶段

```matlab
% 1. 导入解剖MRI
sFiles = bst_process('CallProcess', 'process_import_anatomy', [], [], ...
    'subjectname', 'Subject01', ...
    'mrifile',     'T1.nii');

% 2. 导入通道文件
sFiles = bst_process('CallProcess', 'process_import_channel', sFiles, []);

% 3. 配准头模型
% （通常在GUI中手动标记fiducials）

% 4. 计算头模型
sFiles = bst_process('CallProcess', 'process_headmodel', sFiles, [], ...
    'sourcespace', 1, ...  % Cortex surface
    'meg',         3, ...  % Overlapping spheres
    'eeg',         3);     % OpenMEEG BEM
```

---

### 7.2 源估计

```matlab
% 5. 计算噪声协方差
sFiles = bst_process('CallProcess', 'process_noisecov', sFiles_noise, [], ...
    'baseline',      [-0.1, 0], ...
    'method',        1, ...     % Full
    'datatimewindow', [], ...
    'removedcoffset', 1);

% 6. 计算源
sFiles_src = bst_process('CallProcess', 'process_inverse', sFiles, [], ...
    'method',      2, ...         % dSPM
    'sensortypes', 'MEG, EEG', ...
    'output',      1);            % Kernel

% 7. 投影到源空间
% (自动在可视化时完成，或明确调用)
```

---

## 8. 源空间分析

### 8.1 脑区时间序列提取 (process_extract_scout.m)

```matlab
sFiles_scout = bst_process('CallProcess', 'process_extract_scout', sFiles_src, [], ...
    'scouts',    {'Desikan-Killiany', {'bankssts L', 'bankssts R'}}, ...
    'scoutfunc', 1, ...  % Mean
    'isflip',    1);     % 翻转方向优化SNR
```

**Scout函数：**
- Mean: 平均
- PCA: 第一主成分
- Max: 最大值
- Power: 功率

---

### 8.2 源空间时频分析

```matlab
sFiles_tf = bst_process('CallProcess', 'process_timefreq', sFiles_src, [], ...
    'clusters', {'Desikan-Killiany', {'precentral L'}}, ...
    'edit',     struct(...
        'Method', 'morlet', ...
        'Freqs',  [8:1:12]));
```

---

## 9. 高级技术

### 9.1 噪声归一化

**标准化方法：**
1. **dSPM**: 除以估计标准差
2. **sLORETA**: 除以分辨率矩阵
3. **基于噪声协方差**: 预白化

---

### 9.2 深度加权策略

**参数调整：**

```matlab
'depth',      1,    % 启用深度加权
'weightexp',  0.5,  % 权重指数 (0-1)
'weightlimit', 10   % 最大权重比
```

**经验法则：**
- MEG: weightexp = 0.5
- EEG: weightexp = 0.8（深部源衰减更快）

---

### 9.3 fMRI先验

整合功能MRI约束：

```matlab
'fMRI',      fMRI_file, ...
'fMRIthresh', [], ...
'fMRIoff',    0.1
```

---

## 10. 实用建议

### 10.1 选择合适的方法

| 研究问题 | 推荐方法 |
|---------|---------|
| 认知成分定位 | dSPM, sLORETA |
| 癫痫棘波 | 偶极子扫描 |
| 频域连接性 | LCMV波束形成器 |
| 稳健组分析 | wMNE |
| 单试次分析 | wMNE, LCMV |

---

### 10.2 质量控制

**检查项：**
1. ✓ 头模型对齐（MRI-通道配准）
2. ✓ 噪声协方差秩（rank检查）
3. ✓ 源定位合理性（解剖位置）
4. ✓ 时间课程SNR
5. ✓ 伪迹残留

---

### 10.3 参数调优

**SNR参数：**
- 高质量数据（平均多试次）：SNR = 3-5
- 低质量数据（单试次）：SNR = 1-2

**正则化：**
```matlab
lambda = 1 / SNR²
```

---

## 11. 常见问题

**Q: Kernel vs Full results？**
A:
- **Kernel**: 节省空间，共享逆算子
- **Full**: 每个文件完整源时间序列

**Q: 为何源定位在头皮外？**
A: 检查MRI-通道配准，可能存在配准错误。

**Q: 固定vs松弛方向？**
A: 固定更稳定，松弛更灵活。默认推荐固定。

**Q: 如何选择源空间密度？**
A: 
- 组分析：5000-15000顶点
- 单被试：15000顶点
- 高精度：>50000顶点（计算密集）

---

## 12. 理论扩展

### 12.1 贝叶斯框架

MNE可视为最大后验（MAP）估计：

```matlab
S_MAP = argmax P(S|M) = argmax P(M|S) * P(S)
```

其中：
- P(M|S): 似然（高斯噪声）
- P(S): 先验（高斯，零均值）

---

### 12.2 分辨率矩阵

评估源重建质量：

```matlab
R = W * G  % [nSources × nSources]
```

理想情况：R = I（单位矩阵）
实际：R模糊（交叉混叠）

**点扩散函数（PSF）**：
```matlab
PSF(i,:) = R(i,:)  % 第i个源的扩散
```

---

## 13. 参考文献

1. Hämäläinen & Ilmoniemi (1994). Interpreting magnetic fields of the brain: minimum norm estimates
2. Dale et al. (2000). Dynamic statistical parametric mapping
3. Pascual-Marqui (2002). Standardized low-resolution brain electromagnetic tomography (sLORETA)
4. Van Veen et al. (1997). Localization of brain electrical activity via linearly constrained minimum variance spatial filtering
5. Tadel et al. (2011). Brainstorm: A User-Friendly Application for MEG/EEG Analysis
