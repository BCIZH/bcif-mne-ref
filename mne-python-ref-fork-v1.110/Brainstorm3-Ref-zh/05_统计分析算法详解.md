# Brainstorm3 统计分析算法详解

## 概述

统计分析是神经影像数据分析的关键环节，用于检验假设、识别显著效应并控制假阳性率。Brainstorm3提供20+个统计检验函数，支持参数和非参数方法。

## 1. 参数检验

### 1.1 单样本t检验 (process_test_parametric1.m)

**原假设：** μ = 0

**t统计量：**
```matlab
t = mean(X) / (std(X) / sqrt(n))
df = n - 1
```

**使用场景：**
```matlab
% 检验源活动是否显著不同于零
sFiles_stat = bst_process('CallProcess', 'process_test_parametric1', sFiles, [], ...
    'timewindow',     [0.08, 0.12], ...  % 时间窗口
    'scoutsel',       {}, ...             % ROI选择
    'scoutfunc',      1, ...              % Mean
    'isnorm',         0, ...              % 不使用绝对值
    'avgtime',        0, ...              % 不平均时间
    'avgrow',         0, ...              % 不平均行
    'Comment',        '', ...
    'test_type',      'ttest_onesample', ...
    'tail',           'two');             % 双侧检验
```

**输出：**
- t图（tmap）
- p图（pmap）
- 自由度（df）

---

### 1.2 配对t检验 (process_test_parametric2p.m)

**原假设：** μ_A - μ_B = 0

**公式：**
```matlab
D = X_A - X_B  % 配对差值
t = mean(D) / (std(D) / sqrt(n))
df = n - 1
```

**使用场景：**
- 同一被试不同条件
- 前后测对比

**示例：**
```matlab
% 比较两种任务条件
sFiles_stat = bst_process('CallProcess', 'process_test_parametric2p', ...
    sFiles_A, sFiles_B, [], ...
    'timewindow',     [], ...
    'scoutsel',       {}, ...
    'scoutfunc',      1, ...
    'isnorm',         0, ...
    'avgtime',        0, ...
    'avgrow',         0, ...
    'test_type',      'ttest_paired', ...
    'tail',           'two');
```

---

### 1.3 双样本t检验 (process_test_parametric2.m)

**原假设：** μ_A = μ_B

**等方差假设：**
```matlab
% Pooled variance
sp² = ((n1-1)*s1² + (n2-1)*s2²) / (n1 + n2 - 2)
t = (mean(X1) - mean(X2)) / (sp * sqrt(1/n1 + 1/n2))
df = n1 + n2 - 2
```

**不等方差（Welch检验）：**
```matlab
t = (mean(X1) - mean(X2)) / sqrt(s1²/n1 + s2²/n2)
df = (s1²/n1 + s2²/n2)² / ...
     ((s1²/n1)²/(n1-1) + (s2²/n2)²/(n2-1))
```

**使用场景：**
- 病人vs对照
- 不同实验组

---

### 1.4 方差分析 (ANOVA)

**单因素ANOVA：**
```matlab
% 组间平方和
SS_between = Σ n_i * (mean_i - grand_mean)²

% 组内平方和
SS_within = Σ Σ (x_ij - mean_i)²

% F统计量
F = (SS_between / df_between) / (SS_within / df_within)
```

**重复测量ANOVA：**
处理被试内因素。

---

## 2. 非参数检验

### 2.1 置换检验 (process_test_permutation1.m)

**原理：** 通过随机化生成零分布

**算法：**
```matlab
% 观测统计量
T_obs = compute_statistic(data);

% 置换
for i = 1:nPerm
    % 随机打乱标签
    data_perm = permute_labels(data);
    % 计算置换统计量
    T_perm(i) = compute_statistic(data_perm);
end

% p值
p = (sum(abs(T_perm) >= abs(T_obs)) + 1) / (nPerm + 1);
```

**优点：**
- ✓ 无分布假设
- ✓ 适用于非正态数据
- ✓ 灵活（任何统计量）

**使用：**
```matlab
sFiles_stat = bst_process('CallProcess', 'process_test_permutation1', sFiles, [], ...
    'timewindow',       [], ...
    'scoutsel',         {}, ...
    'scoutfunc',        1, ...
    'isnorm',           0, ...
    'avgtime',          0, ...
    'avgrow',           0, ...
    'randomizations',   1000, ...   % 置换次数
    'tail',             'two');
```

---

### 2.2 聚类置换检验

**解决问题：** 多重比较问题

**算法（1D时间序列）：**
```matlab
% 1. 计算t值
t = compute_ttest(data);

% 2. 阈值化
t_thresh = t .* (abs(t) > threshold);

% 3. 识别聚类
clusters = bwconncomp(t_thresh ~= 0);

% 4. 聚类质量（如：聚类内t值和）
cluster_mass_obs = zeros(1, nClusters);
for c = 1:nClusters
    cluster_mass_obs(c) = sum(abs(t(clusters{c})));
end

% 5. 置换
for perm = 1:nPerm
    % 置换数据
    data_perm = permute_data(data);
    % 计算置换聚类质量
    cluster_mass_perm(perm) = max_cluster_mass(data_perm);
end

% 6. p值（针对每个聚类）
for c = 1:nClusters
    p_cluster(c) = mean(cluster_mass_perm >= cluster_mass_obs(c));
end
```

**优点：**
- ✓ 控制家族错误率（FWER）
- ✓ 考虑时空平滑性

**参数：**
```matlab
'clusteralpha', 0.05  % 聚类形成阈值
```

---

## 3. 多重比较校正

### 3.1 Bonferroni校正

**最保守方法：**
```matlab
p_corrected = p * nComparisons
α_corrected = α / nComparisons
```

**使用：**
```matlab
'correction', 'bonf'
```

**适用：**
- 独立检验
- 小检验数量

---

### 3.2 FDR校正

**错误发现率控制：**

**Benjamini-Hochberg程序：**
```matlab
% 1. 排序p值
[p_sorted, idx] = sort(p);

% 2. 找到最大k
k = find(p_sorted <= (1:N)'/N * q, 1, 'last');

% 3. 拒绝H0
reject = false(N, 1);
reject(idx(1:k)) = true;
```

**使用：**
```matlab
'correction', 'fdr'
```

**优点：**
- ✓ 比Bonferroni宽松
- ✓ 控制FDR而非FWER

---

### 3.3 最大统计量置换

**原理：** 直接估计最大值零分布

```matlab
for perm = 1:nPerm
    data_perm = permute(data);
    T_perm = compute_t(data_perm);
    max_T(perm) = max(abs(T_perm(:)));
end

% 阈值
T_threshold = prctile(max_T, 95);

% 显著性
sig = abs(T_obs) > T_threshold;
```

**特点：**
- FWER控制
- 考虑数据结构
- 计算密集

---

## 4. 效应量

### 4.1 Cohen's d

**定义：**
```matlab
% 单样本
d = mean(X) / std(X)

% 双样本
d = (mean(X1) - mean(X2)) / pooled_std
```

**解释：**
- |d| < 0.2: 小效应
- 0.2 ≤ |d| < 0.5: 中效应
- |d| ≥ 0.8: 大效应

---

### 4.2 Eta squared (η²)

**ANOVA效应量：**
```matlab
η² = SS_effect / SS_total
```

**偏Eta squared：**
```matlab
partial_η² = SS_effect / (SS_effect + SS_error)
```

---

## 5. 时空统计

### 5.1 时间聚类

**1D聚类（时间维度）：**

```matlab
% 时间点t检验
for t = 1:nTime
    [h, p, ~, stats] = ttest(data(:, t));
    T(t) = stats.tstat;
end

% 阈值化
T_thresh = T .* (abs(T) > t_crit);

% 识别时间聚类
clusters = find_clusters_1d(T_thresh);

% 置换检验
p_cluster = permutation_cluster_test(clusters, data);
```

---

### 5.2 空间聚类

**2D聚类（源/传感器维度）：**

```matlab
% 空间t图
T_map = ttest_sources(data);  % [nSources × nTime]

% 空间聚类（某时间点）
T_spatial = T_map(:, t0);
T_thresh = T_spatial .* (abs(T_spatial) > threshold);

% 识别空间聚类（使用邻接矩阵）
adj_matrix = get_adjacency(surface);
clusters = find_clusters_spatial(T_thresh, adj_matrix);
```

---

### 5.3 时空聚类

**3D聚类（源×时间）：**

```matlab
% 时空t图
T = ttest_sources_time(data);  % [nSources × nTime]

% 阈值化
T_thresh = T .* (abs(T) > threshold);

% 时空聚类
clusters = find_clusters_spatiotemporal(T_thresh, adj_spatial);

% 聚类质量
for c = 1:length(clusters)
    mass(c) = sum(abs(T(clusters{c})));
end
```

---

## 6. 贝叶斯统计

### 6.1 贝叶斯t检验

**Bayes Factor (BF)：**
```matlab
BF10 = P(data | H1) / P(data | H0)
```

**解释：**
- BF10 > 3: 支持H1
- BF10 < 1/3: 支持H0
- 1/3 ≤ BF10 ≤ 3: 证据不足

**优点：**
- 量化证据强度
- 可支持零假设
- 不依赖样本量

---

## 7. 实用场景

### 7.1 场景1：ERP组分差异

**目标：** 比较两种刺激诱发的N170成分

```matlab
% 1. 试次平均
sFiles_A_avg = bst_process('CallProcess', 'process_average', sFiles_A, [], ...
    'avgtype',  1, ...  % 试次内
    'keepevents', 0);

sFiles_B_avg = bst_process('CallProcess', 'process_average', sFiles_B, [], ...
    'avgtype',  1, ...
    'keepevents', 0);

% 2. 统计检验（配对，因为同一被试）
sFiles_stat = bst_process('CallProcess', 'process_test_parametric2p', ...
    sFiles_A_avg, sFiles_B_avg, [], ...
    'timewindow',  [0.15, 0.19], ...  % N170窗口
    'scoutsel',    {}, ...
    'avgtime',     1, ...              % 平均时间窗口
    'test_type',   'ttest_paired', ...
    'tail',        'two');

% 3. 多重比较校正
sFiles_corr = bst_process('CallProcess', 'process_test_parametric2p', ...
    sFiles_A_avg, sFiles_B_avg, [], ...
    'timewindow',  [0, 0.5], ...       % 全时段
    'avgtime',     0, ...              % 不平均（逐点）
    'correction',  'fdr');             % FDR校正
```

---

### 7.2 场景2：源空间组比较

**目标：** 病人组vs对照组

```matlab
% 1. 源重建（所有被试）
sFiles_src = bst_process('CallProcess', 'process_inverse', sFiles, []);

% 2. 双样本检验
sFiles_stat = bst_process('CallProcess', 'process_test_parametric2', ...
    sFiles_patients, sFiles_controls, [], ...
    'timewindow',     [0.08, 0.12], ...
    'scoutsel',       {'Desikan-Killiany', {'postcentral L'}}, ...
    'scoutfunc',      1, ...
    'avgtime',        1, ...
    'test_type',      'ttest_equal', ... % 等方差t检验
    'tail',           'two');

% 3. 置换检验（非参数）
sFiles_perm = bst_process('CallProcess', 'process_test_permutation2', ...
    sFiles_patients, sFiles_controls, [], ...
    'randomizations', 5000, ...
    'tail',           'two');
```

---

### 7.3 场景3：时频统计

**目标：** 检验α波段功率变化

```matlab
% 1. 计算时频
sFiles_tf = bst_process('CallProcess', 'process_timefreq', sFiles, []);

% 2. 基线归一化
sFiles_norm = bst_process('CallProcess', 'process_baseline_norm', sFiles_tf, [], ...
    'baseline',  [-0.5, -0.1], ...
    'method',    'ersd');

% 3. 统计检验（频段平均）
sFiles_stat = bst_process('CallProcess', 'process_test_parametric1', sFiles_norm, [], ...
    'timewindow',  [0, 1], ...
    'scoutsel',    {}, ...
    'avgfreq',     [8, 13], ...        % α频段
    'test_type',   'ttest_onesample', ...
    'tail',        'two');

% 4. 聚类校正
sFiles_clust = bst_process('CallProcess', 'process_test_permutation1', sFiles_norm, [], ...
    'randomizations', 1000, ...
    'clusteralpha', 0.05);
```

---

## 8. 功率分析

### 8.1 样本量估计

**t检验：**
```matlab
% 给定：α, power, effect size
% 求：n

% Cohen's d = 0.5, α = 0.05, power = 0.8
n = power.ttest.n(0.5, 0.05, 0.8);
```

**实际数据：**
```matlab
% 基于试验数据估计
d_pilot = mean(diff) / std(diff);
n_required = power.ttest.n(d_pilot, 0.05, 0.8);
```

---

### 8.2 功效检验

**事后分析：**
```matlab
% 已知：n, α, effect size
% 求：achieved power

power_achieved = power.ttest(d_observed, n, 0.05);
```

---

## 9. 稳健统计

### 9.1 中位数检验

**对离群值不敏感：**
```matlab
% Wilcoxon符号秩检验（单样本）
[p, h, stats] = signrank(X);

% Wilcoxon秩和检验（双样本）
[p, h, stats] = ranksum(X1, X2);
```

---

### 9.2 Bootstrap

**重采样估计分布：**
```matlab
% Bootstrap置信区间
nBoot = 1000;
boot_mean = bootstrp(nBoot, @mean, X);
CI = prctile(boot_mean, [2.5, 97.5]);
```

---

## 10. 混合效应模型

### 10.1 固定vs随机效应

**固定效应：**
- 感兴趣的条件效应

**随机效应：**
- 被试间变异
- 试次间变异

### 10.2 线性混合模型（LMM）

**公式：**
```
Y = X*β + Z*u + ε
```

其中：
- β: 固定效应
- u: 随机效应
- ε: 残差

**MATLAB实现：**
```matlab
% 需要Statistics Toolbox
lme = fitlme(tbl, 'Y ~ Condition + (1|Subject)');
```

---

## 11. 元分析

### 11.1 跨研究综合

**固定效应模型：**
```matlab
d_pooled = Σ(w_i * d_i) / Σ(w_i)
w_i = 1 / var(d_i)
```

**随机效应模型：**
考虑研究间变异。

---

## 12. 诊断与质量控制

### 12.1 假设检验

**正态性：**
```matlab
% Shapiro-Wilk检验
[h, p] = swtest(X);

% Q-Q图
qqplot(X);
```

**方差齐性：**
```matlab
% Levene检验
p = vartestn(X, group);
```

---

### 12.2 离群值检测

**Z-score：**
```matlab
z = (X - mean(X)) / std(X);
outliers = abs(z) > 3;
```

**MAD（中位数绝对偏差）：**
```matlab
mad_value = median(abs(X - median(X)));
outliers = abs(X - median(X)) > 3 * mad_value;
```

---

## 13. 报告规范

### 13.1 必需信息

统计报告应包括：
1. **检验类型**：参数/非参数
2. **样本量**：被试数、试次数
3. **统计量**：t/F值，df
4. **p值**：精确值或<0.001
5. **效应量**：Cohen's d, η²
6. **校正方法**：FDR, Bonferroni, cluster
7. **显著性水平**：通常α=0.05

---

### 13.2 示例

**单样本t检验：**
> N170幅度显著不同于零（t(19) = 4.32, p < 0.001, d = 0.97, 双侧）。

**双样本t检验：**
> 两组在α功率上存在显著差异（t(38) = 2.14, p = 0.039, d = 0.68, Welch检验，FDR校正）。

**置换检验：**
> 聚类置换检验显示180-250ms时间窗口存在显著效应（p = 0.012, 1000次置换，聚类α=0.05）。

---

## 14. 常见错误

### 14.1 多重比较未校正

**问题：** 假阳性膨胀

**解决：** 总是使用校正（FDR最低要求）

---

### 14.2 循环分析

**问题：** 用同一数据选择和检验

**正确：**
1. 独立数据选ROI
2. 或用全脑校正

---

### 14.3 p-hacking

**避免：**
- 预注册分析
- 报告所有检验
- 敏感性分析

---

## 15. 参考文献

1. Maris & Oostenveld (2007). Nonparametric statistical testing of EEG- and MEG-data
2. Groppe et al. (2011). Mass univariate analysis of event-related brain potentials/fields
3. Benjamini & Hochberg (1995). Controlling the false discovery rate
4. Cohen (1988). Statistical Power Analysis for the Behavioral Sciences
5. Pernet et al. (2015). Robust correlation analyses: false positive and power validation using a new open source MATLAB toolbox
