# Brainstorm3 预处理算法详解

## 概述

Brainstorm3 提供了40+个预处理函数，用于清洁和准备原始MEG/EEG数据以供后续分析。所有预处理函数位于 `toolbox/process/functions/` 目录，命名规范遵循 `process_*.m` 模式。

## 1. 滤波算法

### 1.1 带通滤波 (process_bandpass.m)

**功能描述：**
实现低通、高通和带通数字滤波器，用于去除不感兴趣的频率成分。

**算法实现：**

```matlab
function [x, FiltSpec] = Compute(x, sfreq, HighPass, LowPass, Method, isMirror, isRelax, TranBand)
% 输入：
%   x         - 信号 [nChannels × nTime]
%   sfreq     - 采样频率
%   HighPass  - 高通截止频率
%   LowPass   - 低通截止频率
%   Method    - 滤波方法
%   isMirror  - 是否镜像信号
%   isRelax   - 阻带衰减 (40dB vs 60dB)
%   TranBand  - 过渡带宽度
```

**支持的滤波方法：**

1. **bst-hfilter-2019** (推荐，默认)
   - 基于Parks-McClellan最优FIR设计
   - 阻带衰减：60dB（严格）或 40dB（宽松）
   - 自适应过渡带宽度
   - 零相位实现（前向-后向滤波）

2. **bst-hfilter-2016**
   - 老版本实现
   - 固定过渡带宽度

3. **bst-fft-fir**
   - 基于FFT的FIR滤波器
   - 2011年之前的实现

**参数说明：**

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| Lower cutoff | float | 0 Hz | 高通截止频率，0=禁用 |
| Upper cutoff | float | 40 Hz | 低通截止频率，0=禁用 |
| Transition band | float | 0 Hz | 过渡带宽度，0=自动计算 |
| Stopband attenuation | 选项 | 60dB | 阻带衰减（60dB严格/40dB宽松）|
| Filter version | 选项 | 2019 | 滤波器版本 |

**使用场景：**

1. **去除低频漂移**
   - 高通滤波：0.5-1 Hz
   - 用于：去除慢漂移、直流分量

2. **去除高频噪声**
   - 低通滤波：40-100 Hz
   - 用于：平滑信号、抗混叠

3. **提取特定频段**
   - 带通滤波：8-12 Hz (α波段)
   - 用于：节律分析、连接性研究

**注意事项：**
- 滤波器阶数自动根据频率和采样率计算
- 边缘效应：信号开始/结束处可能失真
- 不推荐使用镜像选项（2019后）

**示例代码：**

```matlab
% 示例1：带通滤波 (0.5-40 Hz)
sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
    'sensortypes', 'MEG, EEG', ...
    'highpass',    0.5, ...
    'lowpass',     40, ...
    'attenuation', 'strict', ...
    'ver',         '2019');

% 示例2：高通滤波去除漂移
sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
    'highpass',    1, ...
    'lowpass',     0);

% 示例3：低通滤波平滑信号
sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
    'highpass',    0, ...
    'lowpass',     30);
```

---

### 1.2 陷波滤波 (process_notch.m)

**功能描述：**
去除特定频率的正弦干扰，主要用于消除电源线干扰（50/60 Hz）及其谐波。

**算法实现：**

基于IIR陷波滤波器设计，使用二阶节（biquad）级联结构：

```matlab
H(z) = (b0 + b1*z^(-1) + b2*z^(-2)) / (1 + a1*z^(-1) + a2*z^(-2))
```

**设计参数：**
- 中心频率：f0 (要去除的频率)
- 3dB带宽：BW (陷波宽度)
- 品质因数：Q = f0 / BW

**参数说明：**

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| Frequencies to remove | 数组 | [] | 要去除的频率列表 (Hz) |
| 3-dB notch bandwidth | float | 1 Hz | 陷波带宽 |
| Use old implementation | 布尔 | false | 使用2019年前的实现 |

**使用场景：**

1. **去除电源线干扰**
   ```matlab
   % 60 Hz 及其谐波
   sFiles = bst_process('CallProcess', 'process_notch', sFiles, [], ...
       'freqlist',  [60, 120, 180], ...
       'cutoffW',   2);
   ```

2. **去除特定设备干扰**
   ```matlab
   % 例如：扫描仪频率
   sFiles = bst_process('CallProcess', 'process_notch', sFiles, [], ...
       'freqlist',  [50, 100, 150, 200], ...
       'cutoffW',   1);
   ```

**优缺点：**
- ✓ 精确去除特定频率
- ✓ 对相邻频率影响小
- ✗ 多个陷波器可能引入相位失真
- ✗ 不能去除非正弦干扰

---

### 1.3 带阻滤波 (process_bandstop.m)

类似陷波滤波，但去除一个频率范围而非单一频率。

---

## 2. 重采样算法

### 2.1 重采样 (process_resample.m)

**功能描述：**
改变信号采样率，用于降低数据量或匹配不同数据集的采样率。

**算法实现：**

采用多级重采样算法：
1. **抗混叠滤波**：降采样前低通滤波
2. **插值**：使用polyphase滤波器
3. **抽取/插值**：调整采样点

```matlab
% 降采样示例
if sfreq_new < sfreq_old
    % 1. 低通滤波 (截止频率 = sfreq_new/2)
    x = lowpass_filter(x, sfreq_old, sfreq_new/2);
    % 2. 抽取
    x = x(:, 1:R:end);  % R = sfreq_old/sfreq_new
end
```

**参数说明：**

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| New sampling rate | float | 1000 Hz | 目标采样率 |

**使用场景：**

1. **降低计算负担**
   ```matlab
   % 从 1000 Hz 降到 250 Hz
   sFiles = bst_process('CallProcess', 'process_resample', sFiles, [], ...
       'freq', 250);
   ```
   - 用于：减少存储、加速计算
   - 注意：信息损失（仅保留 < 125 Hz 成分）

2. **匹配采样率**
   - 合并不同设备数据
   - 统一分析流程

**重要提示：**
- 降采样必须满足 Nyquist 准则
- 自动应用抗混叠滤波
- 事件时间戳同步调整

---

## 3. 去趋势与基线校正

### 3.1 去趋势 (process_detrend.m)

**功能描述：**
去除线性或高阶多项式趋势。

**算法：**
```matlab
% 线性去趋势
p = polyfit(t, x, 1);           % 拟合一阶多项式
trend = polyval(p, t);          % 计算趋势
x_detrend = x - trend;          % 减去趋势
```

**使用场景：**
- 去除缓慢漂移
- 处理长时程记录

---

### 3.2 基线校正 (process_baseline.m)

**功能描述：**
减去基线期均值，标准化试次。

**算法：**
```matlab
% 基线校正
baseline_mean = mean(x(:, baseline_indices), 2);
x_corrected = x - baseline_mean;
```

**参数：**
- Baseline: 时间窗口 (例如 [-100, 0] ms)
- 方法：
  - 减去均值
  - 归一化
  - Z-score

**使用场景：**
- 事件相关电位（ERP）分析
- 试次间比较

---

## 4. 伪迹检测与处理

### 4.1 坏通道检测 (process_detectbad.m)

**功能描述：**
自动识别有问题的传感器通道。

**检测标准：**

1. **峰峰值法**
   ```matlab
   pp = max(x, [], 2) - min(x, [], 2);  % 每通道峰峰值
   bad = (pp > threshold);               % 超过阈值标记为坏
   ```

2. **标准差法**
   ```matlab
   sigma = std(x, [], 2);
   bad = (sigma > mean(sigma) + k*std(sigma));
   ```

3. **相关性法**
   ```matlab
   R = corr(x');  % 通道间相关矩阵
   avg_corr = mean(R, 2);
   bad = (avg_corr < threshold);  % 低相关性通道
   ```

**参数：**
- Time window: 检测时间窗
- Threshold: MEG/EEG 不同阈值
- Method: 峰峰值/标准差/相关性

**使用场景：**
```matlab
% 自动检测坏通道
sFiles = bst_process('CallProcess', 'process_detectbad', sFiles, [], ...
    'timewindow', [], ...  % 全时段
    'meggrad',    3, ...   % MEG梯度计阈值 (pT/cm)
    'megmag',     3, ...   % MEG磁力计阈值 (pT)
    'eeg',        3, ...   % EEG阈值 (μV)
    'method',     'pp');   % 峰峰值法
```

---

### 4.2 信号空间投影 (SSP, process_ssp.m / process_ssp2.m)

**功能描述：**
使用主成分分析去除伪迹成分（眼动、心跳等）。

**算法原理：**

1. **计算协方差矩阵**
   ```matlab
   C = (X * X') / nTime;  % X: [nChannels × nTime]
   ```

2. **特征值分解**
   ```matlab
   [U, S, V] = svd(C);
   ```

3. **投影矩阵**
   ```matlab
   P = I - U(:, 1:nComp) * U(:, 1:nComp)';  % 去除前nComp个成分
   X_clean = P * X;
   ```

**使用场景：**

1. **去除眼动伪迹 (process_ssp_eog.m)**
   ```matlab
   sFiles = bst_process('CallProcess', 'process_ssp_eog', sFiles, [], ...
       'channelname', 'EOG', ...
       'ncomp',       2);
   ```

2. **去除心跳伪迹 (process_ssp_ecg.m)**
   ```matlab
   sFiles = bst_process('CallProcess', 'process_ssp_ecg', sFiles, [], ...
       'channelname', 'ECG', ...
       'ncomp',       2);
   ```

---

### 4.3 独立成分分析 (ICA, process_ica.m)

**功能描述：**
盲源分离，识别和去除伪迹成分。

**算法：**
- **Infomax ICA**
- **FastICA**
- **JADE**

**工作流程：**
1. 计算独立成分
2. 识别伪迹成分（手动或自动）
3. 重建信号（排除伪迹成分）

**使用场景：**
```matlab
% 计算ICA成分
sFiles = bst_process('CallProcess', 'process_ica', sFiles, [], ...
    'timewindow',  [], ...
    'icaselectmode', 1, ...  % 手动选择
    'method',      'infomax');
```

---

## 5. 其他预处理

### 5.1 时间偏移 (process_timeoffset.m)

**功能：** 校正硬件延迟或调整事件时间。

```matlab
sFiles = bst_process('CallProcess', 'process_timeoffset', sFiles, [], ...
    'offset', -0.004);  % 校正4ms延迟
```

---

### 5.2 缩放 (process_scale.m)

**功能：** 放大/缩小信号幅值。

---

### 5.3 正弦波去除 (process_sin_remove.m)

**功能：** 拟合并去除正弦成分（替代陷波）。

**算法：**
```matlab
% 最小二乘拟合
s = A*sin(2*pi*f*t) + B*cos(2*pi*f*t)
x_clean = x - s
```

---

### 5.4 Maxwell滤波 (process_mne_maxwell.m / process_mne_maxwell_py.m)

**功能：** MEG信号空间分离（SSS）和时序SSS（tSSS）。

**用途：**
- 去除外部干扰
- 补偿头部运动
- 需要MNE-Python

```matlab
sFiles = bst_process('CallProcess', 'process_mne_maxwell_py', sFiles, [], ...
    'origin',      'auto', ...
    'regularize',  'in', ...
    'st_duration', 10);
```

---

## 6. 预处理流程推荐

### 6.1 标准MEG预处理

```matlab
% 1. 坏通道检测
sFiles = bst_process('CallProcess', 'process_detectbad', sFiles, []);

% 2. Maxwell滤波 (可选，仅MEG)
sFiles = bst_process('CallProcess', 'process_mne_maxwell', sFiles, []);

% 3. 陷波滤波
sFiles = bst_process('CallProcess', 'process_notch', sFiles, [], ...
    'freqlist', [60, 120, 180]);

% 4. 带通滤波
sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
    'highpass', 0.5, 'lowpass', 40);

% 5. SSP去除伪迹
sFiles = bst_process('CallProcess', 'process_ssp_eog', sFiles, []);
sFiles = bst_process('CallProcess', 'process_ssp_ecg', sFiles, []);
```

### 6.2 标准EEG预处理

```matlab
% 1. 重参考（平均参考）
sFiles = bst_process('CallProcess', 'process_set_eegref', sFiles, [], ...
    'eegref', 'AVERAGE');

% 2. 陷波滤波
sFiles = bst_process('CallProcess', 'process_notch', sFiles, [], ...
    'freqlist', [50, 100]);

% 3. 带通滤波
sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
    'highpass', 0.1, 'lowpass', 40);

% 4. ICA去伪迹
sFiles = bst_process('CallProcess', 'process_ica', sFiles, []);
```

---

## 7. 性能优化提示

1. **批处理**：使用 `processDim=1` 逐通道处理节省内存
2. **并行处理**：启用 `parallel` 选项加速
3. **原位处理**：直接修改文件而非创建副本
4. **滤波器设计缓存**：相同参数重用滤波器

---

## 8. 常见问题

**Q: 滤波后信号变短？**
A: 边缘效应导致，滤波器需要一定长度。建议使用足够长的数据段。

**Q: 陷波vs带阻滤波？**
A: 陷波去除窄频段（如50Hz），带阻去除宽频段（如45-55Hz）。

**Q: 何时使用ICA vs SSP？**
A: ICA更强大但计算密集；SSP快速但假设伪迹正交。

**Q: 能否撤销预处理？**
A: 大多数操作不可逆，建议保留原始数据副本。

---

## 9. 参考文献

1. Tadel et al. (2011). Brainstorm: A User-Friendly Application for MEG/EEG Analysis
2. Widmann et al. (2015). Digital filter design for electrophysiological data
3. Mitra & Kuo (2006). Digital Signal Processing: A Computer-Based Approach
