# Brainstorm3 事件处理算法详解

## 概述

事件（Events）是神经电生理数据分析的基础单元，标记刺激、响应、伪迹或其他感兴趣时间点。Brainstorm3提供28+个事件处理函数，涵盖检测、分类、合并、导入导出等操作。

## 1. 事件检测

### 1.1 自定义事件检测 (process_evt_detect.m)

**原理：** 基于幅度阈值的峰值检测

**算法流程：**
```matlab
% 1. 读取通道数据
F = in_bst_data(DataFile, chanName);

% 2. 带通滤波
F_filt = bandpass_filter(F, [fLow, fHigh], sfreq);

% 3. 计算动态阈值
threshold = mean(F_filt) + k * std(F_filt);

% 4. 寻找峰值
[peaks, locs] = findpeaks(abs(F_filt), ...
    'MinPeakHeight', threshold, ...
    'MinPeakDistance', blanking * sfreq);

% 5. 创建事件
evt.label = 'cardiac';
evt.times = Time(locs);
evt.epochs = ones(size(locs));
```

**使用场景：**
```matlab
% ECG检测
sFiles = bst_process('CallProcess', 'process_evt_detect', sFiles, [], ...
    'eventname',     'cardiac', ...
    'channelname',   'ECG', ...
    'timewindow',    [], ...
    'bandpass',      [10, 40], ...      % Hz
    'threshold',     4, ...              % × std
    'blanking',      0.5, ...            % 秒
    'isnoisecheck',  1, ...
    'isclassify',    1);

% EOG检测
sFiles = bst_process('CallProcess', 'process_evt_detect', sFiles, [], ...
    'eventname',     'blink', ...
    'channelname',   'VEOG', ...
    'bandpass',      [1.5, 15], ...
    'threshold',     2, ...
    'blanking',      0.8);
```

---

### 1.2 ECG检测 (process_evt_detect_ecg.m)

**专用算法：** Pan-Tompkins QRS检测

**步骤：**
```matlab
% 1. 5-15 Hz带通滤波（增强QRS复合波）
F_bp = bandpass(ECG, [5, 15], sfreq);

% 2. 微分（检测斜率）
F_diff = diff(F_bp);

% 3. 平方（放大大振幅）
F_sq = F_diff .^ 2;

% 4. 移动窗口积分
window = round(0.150 * sfreq);  % 150ms
F_mwi = movmean(F_sq, window);

% 5. 自适应阈值
threshold = 0.6 * max(F_mwi);

% 6. 检测R峰
R_peaks = find_peaks(F_mwi, threshold, 0.2*sfreq);

% 7. 反向映射到原始信号
[~, R_locs] = findpeaks(ECG(R_peaks - window : R_peaks + window));
```

**优点：**
- ✓ 对噪声鲁棒
- ✓ 适应RR间期变化
- ✓ 自动阈值

---

### 1.3 EOG检测 (process_evt_detect_eog.m)

**算法：**
```matlab
% 1. 垂直EOG：VEOG = 上眼睑 - 下眼睑
% 2. 水平EOG：HEOG = 左外眼角 - 右外眼角

% 眨眼检测（垂直）
VEOG_filt = bandpass(VEOG, [1, 10], sfreq);
blink_events = detect_threshold(VEOG_filt, 100);  % μV

% 眼动检测（水平）
HEOG_filt = bandpass(HEOG, [1, 10], sfreq);
saccade_events = detect_threshold(HEOG_filt, 50);
```

---

### 1.4 坏段检测 (process_evt_detect_badsegment.m)

**目的：** 自动标记噪声时段

**指标：**
```matlab
% 峰峰值
pp = max(F) - min(F);

% 标准差
sd = std(F);

% 梯度（高频噪声）
grad = max(abs(diff(F)));

% 阈值
bad = (pp > threshold_pp) | ...
      (sd > threshold_sd) | ...
      (grad > threshold_grad);
```

**使用：**
```matlab
sFiles = bst_process('CallProcess', 'process_evt_detect_badsegment', sFiles, [], ...
    'timewindow',    [], ...
    'sensortypes',   'MEG', ...
    'threshold',     3, ...          % × std
    'isLowFreq',     1, ...          % 检测慢漂移
    'isHighFreq',    1);             % 检测高频噪声
```

---

### 1.5 模拟信号检测 (process_evt_detect_analog.m)

**应用：** 从模拟通道检测触发信号

**算法：**
```matlab
% TTL脉冲检测
analog = in_bst_data(DataFile, 'TRIG');

% 上升沿
rising = find(diff(analog > threshold) == 1);

% 下降沿
falling = find(diff(analog > threshold) == -1);

% 创建extended事件（有持续时间）
evt.times = [Time(rising); Time(falling)];
evt.label = 'Trigger';
```

**参数：**
- 阈值：TTL电平（如2.5V）
- 去抖：最小脉宽

---

## 2. 事件操作

### 2.1 合并事件 (process_evt_merge.m)

**功能：** 将多个事件类型合并为一个

```matlab
sFiles = bst_process('CallProcess', 'process_evt_merge', sFiles, [], ...
    'evtnames',   'stimulus, target', ...  % 源事件
    'newname',    'all_trials', ...        % 新名称
    'delete',     0);                      % 保留源事件
```

---

### 2.2 重命名事件 (process_evt_rename.m)

```matlab
sFiles = bst_process('CallProcess', 'process_evt_rename', sFiles, [], ...
    'src',   'standard', ...
    'dest',  'Standard');
```

---

### 2.3 删除事件 (process_evt_delete.m)

```matlab
sFiles = bst_process('CallProcess', process_evt_delete', sFiles, [], ...
    'eventname', 'artifact, bad_*');  % 支持通配符
```

---

### 2.4 组合事件 (process_evt_combine.m)

**逻辑组合：**

```matlab
% AND：A和B同时发生
sFiles = bst_process('CallProcess', 'process_evt_combine', sFiles, [], ...
    'combine',   'A & B', ...
    'dt',        0.05, ...      % 容差：50ms
    'delete',    0);

% OR：A或B发生
'combine',   'A | B'

% XOR：仅A或仅B
'combine',   'A ^ B'
```

**实例：**
```matlab
% 检测oddball任务中的正确响应
sFiles = bst_process('CallProcess', 'process_evt_combine', sFiles, [], ...
    'combine',   'target & correct_response', ...
    'dt',        0.8, ...       % 0.8秒内
    'delete',    0);
```

---

### 2.5 按名称分组 (process_evt_groupname.m)

**应用：** 根据事件名称模式分组

```matlab
% 将 'stimulus_1', 'stimulus_2', ... 分组为 'stimulus'
sFiles = bst_process('CallProcess', 'process_evt_groupname', sFiles, [], ...
    'pattern',     'stimulus_*', ...
    'newname',     'stimulus', ...
    'method',      'merge');     % 或 'delete'
```

---

### 2.6 按时间分组 (process_evt_grouptime.m)

**簇化事件：** 将时间接近的事件归为一组

```matlab
% 将500ms内的事件视为一个trial
sFiles = bst_process('CallProcess', 'process_evt_grouptime', sFiles, [], ...
    'eventname',   'spike', ...
    'maxtime',     0.5, ...       % 最大间隔
    'newname',     'burst');
```

---

### 2.7 时间偏移 (process_evt_timeoffset.m)

**校正延迟：**

```matlab
% 所有事件延迟10ms
sFiles = bst_process('CallProcess', 'process_evt_timeoffset', sFiles, [], ...
    'eventname',  'all', ...
    'offset',     0.010, ...      % 秒
    'overwrite',  1);
```

---

### 2.8 扩展事件 (process_evt_extended.m)

**创建时间段事件：**

```matlab
% 将点事件转为50ms时间窗
sFiles = bst_process('CallProcess', 'process_evt_extended', sFiles, [], ...
    'eventname',  'stimulus', ...
    'duration',   0.050, ...      % 持续时间
    'method',     'after');       % 向后扩展
```

**选项：**
- 'before': 向前
- 'after': 向后
- 'symmetric': 双向

---

## 3. 事件分类

### 3.1 自动分类 (process_evt_classify.m)

**应用：** 将事件按特征聚类

**示例：心跳分类**
```matlab
% 基于ECG波形相似度分类
sFiles = bst_process('CallProcess', 'process_evt_classify', sFiles, [], ...
    'eventname',    'cardiac', ...
    'channelname',  'ECG', ...
    'timewindow',   [-0.2, 0.4], ...  % R峰周围窗口
    'n_cluster',    2, ...             % 聚类数
    'method',       'kmeans');         % k-means聚类

% 输出：cardiac_1, cardiac_2
```

**聚类方法：**
- k-means: 基于波形相似度
- hierarchical: 层次聚类
- dbscan: 密度聚类

---

### 3.2 多响应分类 (process_evt_multiresp.m)

**任务：** oddball范式响应分类

```matlab
% 根据反应时和正确性分类
sFiles = bst_process('CallProcess', 'process_evt_multiresp', sFiles, [], ...
    'stim',       'target', ...
    'resp',       'button', ...
    'dt',         [0.2, 1.5], ...     % 有效反应时
    'correct',    1);                 % 仅正确试次

% 输出：target_correct, target_incorrect
```

---

## 4. 事件导入导出

### 4.1 导入事件 (process_evt_import.m)

**支持格式：**
- .txt (ASCII文本)
- .csv
- .evt (ANT NeuroScan)
- .vmrk (BrainVision)
- .trg (Neuroscan)
- MATLAB .mat

**示例：**
```matlab
% 导入文本文件（每行：时间 标签）
sFiles = bst_process('CallProcess', 'process_evt_import', sFiles, [], ...
    'evtfile',   '/path/to/events.txt', ...
    'evtname',   'imported', ...
    'delete',    0);
```

**文本格式：**
```
0.500  stimulus_A
1.200  response
2.100  stimulus_B
```

---

### 4.2 读取事件 (process_evt_read.m)

**从原始数据提取：**

```matlab
% 重新读取原始文件中的事件
sFiles = bst_process('CallProcess', 'process_evt_read', sFiles, []);
```

**应用：** 恢复被删除的原始事件

---

### 4.3 事件转移 (process_evt_transfer.m)

**功能：** 将事件从一个文件复制到另一个

```matlab
sFiles = bst_process('CallProcess', 'process_evt_transfer', ...
    sFilesSource, sFilesDest, [], ...
    'eventname',  'all', ...
    'method',     'overwrite');  % 或 'merge'
```

**使用场景：**
- 从原始数据复制事件到导入数据
- 批量应用事件修改

---

## 5. 特殊事件处理

### 5.1 删除同时发生的事件 (process_evt_remove_simult.m)

**问题：** 两个事件几乎同时发生

```matlab
sFiles = bst_process('CallProcess', 'process_evt_remove_simult', sFiles, [], ...
    'event1',    'A', ...
    'event2',    'B', ...
    'dt',        0.001, ...      % 1ms内
    'remove',    'B');           % 删除B
```

---

### 5.2 cHPI检测 (process_evt_detect_chpi.m)

**连续头位指示（MEG）：**

检测cHPI线圈信号，用于头动校正。

```matlab
sFiles = bst_process('CallProcess', 'process_evt_detect_chpi', sFiles, []);
```

---

### 5.3 头动检测 (process_evt_detect_head_motion.m)

**MEG头位变化：**

```matlab
sFiles = bst_process('CallProcess', 'process_evt_detect_head_motion', sFiles, [], ...
    'threshold',  5, ...         % 5mm位移
    'window',     1);            % 1秒窗口
```

---

## 6. HED标注

### 6.1 导入HED (process_evt_importhed.m)

**Hierarchical Event Descriptors：** 结构化事件描述

```matlab
sFiles = bst_process('CallProcess', 'process_evt_importhed', sFiles, [], ...
    'hedfile',    '/path/to/events.json');
```

**JSON格式：**
```json
{
  "stimulus": {
    "HED": "Sensory-event, Visual-presentation, (Image, Face)"
  },
  "response": {
    "HED": "Agent-action, Behavioral-evidence, (Button-press, Index-finger)"
  }
}
```

---

### 6.2 导出HED (process_evt_exporthed.m)

```matlab
sFiles = bst_process('CallProcess', 'process_evt_exporthed', sFiles, [], ...
    'outputfile', '/path/to/events_hed.json');
```

---

### 6.3 统一HED (process_evt_uniformhed.m)

**标准化HED标签：**

```matlab
sFiles = bst_process('CallProcess', 'process_evt_uniformhed', sFiles, []);
```

---

## 7. 通道事件

### 7.1 通道信息标注 (process_evt_channelinfo.m)

**将通道状态作为事件：**

```matlab
% 标记参考通道变化
sFiles = bst_process('CallProcess', 'process_evt_channelinfo', sFiles, [], ...
    'channelname',  'all', ...
    'property',     'Reference');
```

---

## 8. 实用场景

### 8.1 场景1：ERP分析事件准备

**目标：** 从连续数据提取刺激锁定试次

```matlab
% 1. 检测刺激事件（从trigger通道）
sFiles = bst_process('CallProcess', 'process_evt_detect_analog', sFiles, [], ...
    'eventname',   'trigger', ...
    'channelname', 'TRIG', ...
    'threshold',   2.5);

% 2. 根据编码分类
% 假设trigger值编码条件：1=标准，2=偏差
sFiles = bst_process('CallProcess', 'process_evt_simple', sFiles, [], ...
    'eventname',  'trigger', ...
    'method',     'by_value', ...
    'values',     '1, 2', ...
    'newnames',   'standard, deviant');

% 3. 删除原始trigger事件
sFiles = bst_process('CallProcess', 'process_evt_delete', sFiles, [], ...
    'eventname',  'trigger');

% 4. 检测行为响应
sFiles = bst_process('CallProcess', 'process_evt_detect_analog', sFiles, [], ...
    'eventname',   'response', ...
    'channelname', 'RESP');

% 5. 分类正确/错误响应
sFiles = bst_process('CallProcess', 'process_evt_multiresp', sFiles, [], ...
    'stim',    'deviant', ...
    'resp',    'response', ...
    'dt',      [0.2, 1.0]);

% 输出：standard, deviant_correct, deviant_incorrect
```

---

### 8.2 场景2：伪迹剔除流程

**完整伪迹处理管道：**

```matlab
% 1. 检测ECG
sFiles = bst_process('CallProcess', 'process_evt_detect_ecg', sFiles, [], ...
    'channelname',  'ECG', ...
    'eventname',    'cardiac');

% 2. 检测EOG
sFiles = bst_process('CallProcess', 'process_evt_detect_eog', sFiles, [], ...
    'channelname',  'VEOG', ...
    'eventname',    'blink');

% 3. 检测坏段
sFiles = bst_process('CallProcess', 'process_evt_detect_badsegment', sFiles, [], ...
    'sensortypes',  'MEG', ...
    'eventname',    'bad_segment', ...
    'threshold',    3);

% 4. 扩展坏段（安全边界）
sFiles = bst_process('CallProcess', 'process_evt_extended', sFiles, [], ...
    'eventname',   'bad_segment', ...
    'duration',    0.5, ...
    'method',      'symmetric');

% 5. 合并所有伪迹
sFiles = bst_process('CallProcess', 'process_evt_merge', sFiles, [], ...
    'evtnames',  'cardiac, blink, bad_segment', ...
    'newname',   'artifact', ...
    'delete',    0);
```

---

### 8.3 场景3：事件批处理

**批量修改多个被试的事件：**

```matlab
% 获取所有被试文件
sFiles = bst_process('CallProcess', 'process_select_files_data', [], []);

% 重命名事件（统一命名）
sFiles = bst_process('CallProcess', 'process_evt_rename', sFiles, [], ...
    'src',   'Stimulus/S  1', ...
    'dest',  'standard');

sFiles = bst_process('CallProcess', 'process_evt_rename', sFiles, [], ...
    'src',   'Stimulus/S  2', ...
    'dest',  'deviant');

% 删除不需要的事件
sFiles = bst_process('CallProcess', 'process_evt_delete', sFiles, [], ...
    'eventname',  'Response/*');

% 导出事件列表
sFiles = bst_process('CallProcess', 'process_evt_export', sFiles, [], ...
    'outputdir',  '/path/to/events/');
```

---

### 8.4 场景4：时间对齐

**刺激-响应延迟校正：**

```matlab
% 1. 测量系统延迟（如：屏幕刷新+光电二极管）
% 假设测得延迟为16.7ms（60Hz显示器）

% 2. 校正刺激事件
sFiles = bst_process('CallProcess', 'process_evt_timeoffset', sFiles, [], ...
    'eventname',  'visual_*', ...
    'offset',     0.0167);      % 向后推16.7ms
```

---

## 9. 编程接口

### 9.1 手动创建事件

```matlab
% 加载数据
DataMat = in_bst_data(DataFile);

% 创建事件结构
evt = db_template('event');
evt.label = 'my_event';
evt.times = [1.0, 2.5, 4.3];       % 秒
evt.epochs = [1, 1, 1];            % epoch索引
evt.channels = [];                 % 无通道特异性
evt.notes = [];

% 添加到文件
if isfield(DataMat, 'Events')
    DataMat.Events(end+1) = evt;
else
    DataMat.Events = evt;
end

% 保存
bst_save(DataFile, DataMat, 'v6', 1);
```

---

### 9.2 Extended事件

**有持续时间的事件：**

```matlab
evt.label = 'stimulus';
evt.times = [0.5, 0.55;    % [开始; 结束]
             1.2, 1.25;
             2.1, 2.15];
evt.epochs = [1; 1; 1];
```

**可视化：** 在时间轴上显示为矩形

---

### 9.3 事件查询

```matlab
% 获取特定事件的时间
DataMat = in_bst_data(DataFile);
iEvt = find(strcmpi({DataMat.Events.label}, 'stimulus'));
times = DataMat.Events(iEvt).times;

% 统计
nOccurrences = length(times);
isi = diff(times);  % 事件间隔
```

---

## 10. 事件可视化

### 10.1 时间序列叠加

```matlab
% 打开数据查看器
view_timeseries(DataFile, 'MEG');

% 事件显示为垂直线或阴影区域
% - 点事件：垂直线
% - 扩展事件：矩形
```

---

### 10.2 事件标签

**颜色编码：**
- 每种事件类型自动分配颜色
- 可手动修改：右键 → Properties

**标签：**
- 显示事件名称
- 双击编辑

---

## 11. 高级技巧

### 11.1 事件算术

**自定义组合逻辑：**

```matlab
% 检测A后出现的B（序列）
sFiles = bst_process('CallProcess', 'process_evt_combine', sFiles, [], ...
    'combine',  'A > B', ...    % A在B之前
    'dt',       0.5, ...        % 500ms内
    'newname',  'A_then_B');
```

---

### 11.2 正则表达式匹配

```matlab
% 删除所有以"bad"开头的事件
sFiles = bst_process('CallProcess', 'process_evt_delete', sFiles, [], ...
    'eventname',  'bad.*');     % 正则表达式
```

---

### 11.3 批量导入

**从电子表格导入：**

```matlab
% events.csv:
% Time, Label, Duration
% 0.5,  stimulus, 0.05
% 1.2,  response, 0
% ...

events_table = readtable('events.csv');

for i = 1:height(events_table)
    evt(i).label = events_table.Label{i};
    evt(i).times = events_table.Time(i);
    if events_table.Duration(i) > 0
        evt(i).times = [evt(i).times; 
                        evt(i).times + events_table.Duration(i)];
    end
    evt(i).epochs = 1;
end

% 保存
DataMat.Events = evt;
bst_save(DataFile, DataMat);
```

---

## 12. 常见问题

### 12.1 事件丢失

**原因：**
- 时间范围外
- 被坏段覆盖

**解决：**
```matlab
% 检查事件时间
DataMat = in_bst_data(DataFile);
all_times = [DataMat.Events.times];
fprintf('事件范围: %.2f - %.2f 秒\n', min(all_times), max(all_times));

% 检查数据时间
fprintf('数据范围: %.2f - %.2f 秒\n', DataMat.Time(1), DataMat.Time(end));
```

---

### 12.2 事件重复

**去重：**
```matlab
% 手动去重
evt.times = unique(evt.times);

% 或删除接近的事件
dt_min = 0.001;  % 1ms
evt.times = evt.times([true, diff(evt.times) > dt_min]);
```

---

### 12.3 事件命名冲突

**避免特殊字符：**
- 不使用：`/ \ : * ? " < > |`
- 推荐：`stimulus_A`, `response_1`

---

## 13. 性能优化

### 13.1 大文件事件检测

**策略：**
```matlab
% 分段处理
segment_length = 60;  % 60秒
nSegments = ceil(DataMat.Time(end) / segment_length);

for i = 1:nSegments
    t_start = (i-1) * segment_length;
    t_end = min(i * segment_length, DataMat.Time(end));
    
    % 检测当前段
    evt_seg = process_evt_detect('Compute', F, Time, OPTIONS);
    
    % 合并
    evt_all = [evt_all, evt_seg];
end
```

---

### 13.2 批量操作

**并行处理多个文件：**
```matlab
% 使用parfor（需要Parallel Computing Toolbox）
parfor iFile = 1:length(sFiles)
    OutputFiles{iFile} = process_evt_detect('Run', sProcess, sFiles(iFile));
end
```

---

## 14. 参考文献

1. Delorme & Makeig (2004). EEGLAB: an open source toolbox for analysis of single-trial EEG dynamics
2. Pan & Tompkins (1985). A real-time QRS detection algorithm
3. Widmann et al. (2015). Digital filter design for electrophysiological data
4. Robbins et al. (2020). HED: Hierarchical Event Descriptors

---

## 附录：事件处理函数速查表

| 函数 | 功能 | 主要参数 |
|------|------|----------|
| `process_evt_detect` | 自定义检测 | 阈值, 带通, blanking |
| `process_evt_detect_ecg` | ECG检测 | 通道名 |
| `process_evt_detect_eog` | EOG检测 | 垂直/水平 |
| `process_evt_detect_badsegment` | 坏段检测 | 阈值, 时间窗 |
| `process_evt_merge` | 合并事件 | 源事件, 新名称 |
| `process_evt_rename` | 重命名 | 源名称, 目标名称 |
| `process_evt_delete` | 删除 | 事件名（支持通配符） |
| `process_evt_combine` | 逻辑组合 | 组合表达式, dt |
| `process_evt_groupname` | 按名称分组 | 模式, 方法 |
| `process_evt_grouptime` | 按时间分组 | 最大间隔 |
| `process_evt_timeoffset` | 时间偏移 | 偏移量 |
| `process_evt_extended` | 扩展事件 | 持续时间, 方向 |
| `process_evt_classify` | 自动分类 | 聚类数, 方法 |
| `process_evt_import` | 导入事件 | 文件路径, 格式 |
| `process_evt_transfer` | 转移事件 | 源/目标文件 |
