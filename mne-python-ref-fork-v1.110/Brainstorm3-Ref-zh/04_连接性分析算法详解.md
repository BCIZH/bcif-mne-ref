# Brainstorm3 连接性分析算法详解

## 概述

连接性分析（Connectivity Analysis）研究大脑不同区域间的功能或有效连接，揭示神经网络的相互作用模式。Brainstorm3提供25+个连接性测量方法。

## 1. 连接性类型

### 1.1 分类体系

```
连接性
├── 功能连接性（Functional Connectivity）
│   ├── 相关性（Correlation）
│   ├── 相干性（Coherence）
│   ├── 相位锁定值（PLV）
│   └── 幅度包络相关（AEC）
│
└── 有效连接性（Effective Connectivity）
    ├── Granger因果（Granger Causality）
    ├── 部分定向相干（PDC）
    ├── 定向传递函数（DTF）
    └── 相位传递熵（PTE）
```

---

## 2. 相关性分析

### 2.1 Pearson相关 (process_corr1n.m, process_corr1.m)

**公式：**
```matlab
r(i,j) = cov(x_i, x_j) / (std(x_i) * std(x_j))

或向量化：
r(i,j) = (x_i - mean(x_i))' * (x_j - mean(x_j)) / ...
         (||x_i - mean(x_i)|| * ||x_j - mean(x_j)||)
```

**使用示例：**

```matlab
% NxN相关矩阵（所有源对）
sFiles = bst_process('CallProcess', 'process_corr1n', sFiles, [], ...
    'timewindow',  [0, 1], ...        % 时间窗口
    'scouts',      {}, ...             % 选择ROI
    'scoutfunc',   1, ...              % Mean
    'scouttime',   2, ...              % After
    'scalarprod',  0, ...              % 非标量积
    'outputmode',  1);                 % 保存单文件
```

**连接图类型：**

| 选项 | 说明 | 输出 |
|------|------|------|
| process_corr1n | NxN | 对称矩阵 [N×N] |
| process_corr1 | 1xN | 种子相关 [1×N] |
| process_corr2 | AxB | A组与B组 [A×B] |

---

### 2.2 时间分辨相关 (process_corr1n_time.m)

**滑窗相关：**
```matlab
for t = 1:hop:nTime
    window = x(:, t:t+win_len);
    R(:,:,t) = corr(window');
end
```

**动态连接性：**

```matlab
sFiles = bst_process('CallProcess', 'process_corr1n_time', sFiles, [], ...
    'timewindow',   [], ...
    'scouts',       scouts, ...
    'scoutfunc',    1, ...
    'timeres',      'windowed', ...
    'avgwinlength', 1, ...          % 1秒窗口
    'avgwinoverlap', 50);           % 50%重叠
```

---

## 3. 相干性分析

### 3.1 幅度平方相干 (MSC, process_cohere1n.m)

**定义：**
```matlab
Cxy(f) = |Sxy(f)|² / (Sxx(f) * Syy(f))
```

其中：
- Sxy(f): 互功率谱密度
- Sxx(f), Syy(f): 自功率谱密度

**取值范围：** 0 ≤ Cxy(f) ≤ 1

---

### 3.2 虚相干 (Imaginary Coherence, icohere2019)

**动机：** 消除体积传导效应

**公式：**
```matlab
iCoh(f) = imag(Sxy(f)) / sqrt(Sxx(f) * Syy(f))
```

**优点：**
- ✓ 对体积传导不敏感
- ✓ 仅捕获真实相位延迟

**缺点：**
- ✗ 可能低估真实连接
- ✗ 零延迟连接被忽略

---

### 3.3 滞后相干 (Lagged Coherence, lcohere2019)

**也称：** 校正虚相干（Corrected Imaginary Coherence）

**公式：**
```matlab
lCoh(f) = imag(Sxy(f)) / sqrt(Sxx(f)*Syy(f) - real(Sxy(f))²)
```

**优势：**
- 无偏估计
- 更好的统计特性

---

### 3.4 使用示例

```matlab
% 计算相干性 NxN
sFiles = bst_process('CallProcess', 'process_cohere1n', sFiles, [], ...
    'timewindow',     [], ...
    'scouts',         {}, ...
    'scoutfunc',      1, ...              % Mean
    'scouttime',      2, ...              % After
    'cohmeasure',     'mscohere', ...     % 或 'icohere2019', 'lcohere2019'
    'tfmeasure',      'hilbert', ...      % 或 'morlet', 'stft'
    'tfedit',         struct(...
        'Freqs',      [8:1:13]), ...      % α频段
    'timeres',        'full', ...         % 需要试次
    'outputmode',     'avg');             % 跨试次平均
```

**时频方法选择：**
- **hilbert**: 快速，单频段
- **morlet**: 多频段，精确
- **stft**: 宽带，平滑

---

## 4. 相位连接性

### 4.1 相位锁定值 (PLV, process_plv1n.m)

**原理：** 测量相位一致性

**公式：**
```matlab
PLV(i,j,f) = |mean(exp(i*(φ_i(t,f) - φ_j(t,f))))|
```

其中 φ(t,f) 是瞬时相位。

**取值：** 0（随机）到 1（完全同步）

**实现：**
```matlab
% 1. 提取相位（通过Hilbert或Morlet）
phase_i = angle(TF_i);
phase_j = angle(TF_j);

% 2. 相位差
delta_phi = phase_i - phase_j;

% 3. PLV
PLV = abs(mean(exp(1i * delta_phi), trials));
```

---

### 4.2 加权相位滞后指数 (wPLI, process_wpli1n.m)

**动机：** PLV受体积传导影响

**公式：**
```matlab
wPLI = |mean(imag(Sxy) .* sign(imag(Sxy)))| / mean(|imag(Sxy)|)
```

**优点：**
- ✓ 不受零相位延迟影响
- ✓ 更稳健于噪声

---

### 4.3 去偏PLV (dwPLI)

**公式：**
```matlab
dwPLI = (sum(imag(Sxy))² - sum(imag(Sxy)²)) / ...
        (sum(imag(Sxy))² - sum(imag(Sxy))²)
```

**特点：**
- 样本量偏差校正
- 更准确（需更多试次）

---

## 5. 幅度连接性

### 5.1 幅度包络相关 (AEC, process_aec1n.m)

**算法步骤：**

```matlab
% 1. 带通滤波
x_filt = bandpass(x, f_low, f_high);

% 2. Hilbert变换提取包络
env = abs(hilbert(x_filt));

% 3. 包络相关
AEC = corr(env);
```

**正交化（去除体积传导）：**
```matlab
% 1. 对信号做Hilbert
x_analytic = hilbert(x);

% 2. 正交化
x_j_orth = imag(x_j_analytic * conj(x_i_analytic) / x_i_analytic);

% 3. 提取正交化包络
env_j_orth = abs(x_j_orth);

% 4. 相关
AEC_orth = corr(env_i, env_j_orth);
```

**使用：**
```matlab
sFiles = bst_process('CallProcess', 'process_aec1n', sFiles, [], ...
    'timewindow',  [], ...
    'scouts',      {}, ...
    'scoutfunc',   1, ...
    'scouttime',   1, ...          % Before
    'freqbands',   {'alpha', '8, 13'; ...
                    'beta',  '13, 30'}, ...
    'isorth',      1, ...          % 正交化
    'outputmode',  1);
```

**使用场景：**
- 静息态网络
- 慢振荡相互作用
- 跨频段耦合

---

## 6. Granger因果分析

### 6.1 原理

**问题：** x能否预测y（超过y的历史）？

**模型：**
```matlab
% 单变量AR模型
y(t) = Σ a_i * y(t-i) + ε_y(t)

% 双变量AR模型
y(t) = Σ a_i * y(t-i) + Σ b_i * x(t-i) + ε_xy(t)
```

**Granger因果：**
```matlab
F_x→y = log(var(ε_y) / var(ε_xy))
```

若 F_x→y > 0 且显著，则 x Granger-导致 y

---

### 6.2 频域Granger因果 (process_granger1n.m)

**谱Granger因果：**

```matlab
% 通过MVAR模型计算
[A, Sigma] = mvar_fit(X, order);  % 拟合多元AR
[S, H, Sigma] = mvar2cpsd(A, Sigma);  % 转换到频域

% 计算Granger
F_ij(f) = log(S_jj(f) / (S_jj(f) - |H_ji(f)|² * Sigma_ii))
```

**使用示例：**

```matlab
sFiles = bst_process('CallProcess', 'process_granger1n', sFiles, [], ...
    'timewindow',   [], ...
    'scouts',       scouts, ...
    'scoutfunc',    1, ...
    'scouttime',    1, ...
    'freqbands',    {'alpha', '8, 13'}, ...
    'mvaralg',      1, ...        % Vieira-Morf
    'momax',        20, ...       % 模型阶数
    'outputmode',   1);
```

**模型阶数选择：**
- AIC（赤池信息准则）
- BIC（贝叶斯信息准则）
- 经验：order ≈ 2 * sfreq / f_min

---

### 6.3 部分定向相干 (PDC, process_pdc1n.m)

**定义：**
```matlab
PDC_ij(f) = A_ij(f) / sqrt(Σ_k |A_kj(f)|²)
```

**解释：**
- 归一化的传递函数
- 表示i对j的相对影响

---

### 6.4 定向传递函数 (DTF)

**定义：**
```matlab
DTF_ij(f) = H_ij(f) / sqrt(Σ_k |H_ik(f)|²)
```

**与PDC区别：**
- PDC: 直接连接
- DTF: 直接+间接连接

---

## 7. 信息理论方法

### 7.1 互信息 (Mutual Information)

**定义：**
```matlab
MI(X,Y) = Σ p(x,y) * log(p(x,y) / (p(x)*p(y)))
```

**应用：**
- 非线性连接
- 不假设关系类型

---

### 7.2 传递熵 (Transfer Entropy)

**定义：**
```matlab
TE_X→Y = I(Y_future; X_past | Y_past)
```

**优势：**
- 捕获非线性因果
- 模型无关

---

### 7.3 相位传递熵 (PTE, process_pte1n.m)

**基于相位的传递熵：**

```matlab
sFiles = bst_process('CallProcess', 'process_pte1n', sFiles, [], ...
    'timewindow',  [], ...
    'scouts',      scouts, ...
    'scoutfunc',   1, ...
    'scouttime',   1, ...
    'freqbands',   {'alpha', '8, 13'}, ...
    'outputmode',  1);
```

---

## 8. 图论分析

### 8.1 从连接性到图

**阈值化：**
```matlab
% 固定阈值
G = (ConnMatrix > threshold);

% 比例阈值（保留前N%最强连接）
G = threshold_proportional(ConnMatrix, 0.2);  % 保留20%

% 统计阈值
G = (pMatrix < 0.05);
```

---

### 8.2 图指标

**节点指标：**
- **度（Degree）**: 连接数
- **聚类系数（Clustering Coefficient）**: 局部连通性
- **介数中心性（Betweenness Centrality）**: 桥接作用

**全局指标：**
- **特征路径长度（Characteristic Path Length）**: 平均最短路径
- **全局效率（Global Efficiency）**: 信息传递效率
- **模块化（Modularity）**: 社区结构

**使用Brain Connectivity Toolbox：**
```matlab
% 需要安装BCT插件
deg = degrees_und(G);
C = clustering_coef_bu(G);
L = charpath(distance_bin(G));
```

---

## 9. 实际应用场景

### 9.1 场景1：静息态功能连接

**目标：** 识别静息态网络（DMN, DAN等）

```matlab
% 1. 长时段静息数据导入
sFiles = bst_process('CallProcess', 'process_import_data_time', ...);

% 2. 带通滤波（慢波）
sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
    'highpass', 0.01, ...
    'lowpass',  0.1);

% 3. 定义脑区（Scout）
scouts = {'Desikan-Killiany', {'PCC', 'mPFC', 'IPL L', 'IPL R'}};

% 4. 计算相关性
sFiles_conn = bst_process('CallProcess', 'process_corr1n', sFiles, [], ...
    'scouts',     scouts, ...
    'scoutfunc',  1, ...  % Mean
    'outputmode', 1);

% 5. 可视化连接矩阵
% 预期：PCC-mPFC强连接（DMN核心）
```

---

### 9.2 场景2：任务态有效连接

**目标：** 分析运动皮层到感觉皮层的信息流

```matlab
% 1. 源重建（运动任务）
sFiles_src = bst_process('CallProcess', 'process_inverse', sFiles, []);

% 2. 定义ROI
scouts = {'Desikan-Killiany', {'precentral L', 'postcentral L'}};

% 3. Granger因果分析
sFiles_granger = bst_process('CallProcess', 'process_granger1n', sFiles_src, [], ...
    'scouts',      scouts, ...
    'freqbands',   {'beta', '13, 30'}, ...
    'momax',       15);

% 4. 检查 precentral→postcentral 因果强度
% 预期：运动执行期间，运动皮层驱动感觉皮层
```

---

### 9.3 场景3：跨频段耦合

**目标：** 研究θ相位调制γ幅度

```matlab
% 1. 计算PAC
sFiles_pac = bst_process('CallProcess', 'process_pac_dynamic', sFiles, [], ...
    'nesting',   [4, 8], ...      % θ频段（相位）
    'nested',    [60, 150], ...   % γ频段（幅度）
    'measure',   'meanvect', ...
    'timewindow', [0, 1]);

% 2. 统计显著性（置换检验）
sFiles_pac_sur = bst_process('CallProcess', 'process_pac_dynamic_sur2', ...
    sFiles, [], 'nperm', 200);

% 应用：工作记忆、学习过程
```

---

## 10. 统计推断

### 10.1 网络水平推断（NBS）

**Network-Based Statistic：**

```matlab
% 1. 计算连接矩阵（所有被试）
for subj = 1:nSubjects
    C(:,:,subj) = compute_connectivity(data{subj});
end

% 2. 连接水平t检验
for i = 1:N
    for j = i+1:N
        [h,p,~,stats] = ttest(squeeze(C(i,j,:)));
        T(i,j) = stats.tstat;
    end
end

% 3. 阈值化形成组件
G = (T > t_threshold);
components = bwconncomp(G);

% 4. 置换检验
% ... 计算组件大小的零分布
```

---

### 10.2 FDR校正

```matlab
% 对连接矩阵p值FDR校正
p_fdr = mafdr(p_values(:), 'BHFDR', true);
p_fdr = reshape(p_fdr, size(p_values));
```

---

## 11. 陷阱与注意事项

### 11.1 体积传导问题

**问题：** 两个传感器记录同一源

**解决方案：**
1. 使用虚相干/滞后相干
2. 源空间连接性（而非传感器空间）
3. 正交化（AEC）
4. 相位延迟方法

---

### 11.2 源泄漏

**问题：** 源重建时相邻源混叠

**策略：**
1. 使用正则化
2. 对称正交化（Colclough 2015）
3. 检查源距离

---

### 11.3 信噪比

**低SNR影响：**
- 相干性高估
- Granger因果虚假

**对策：**
- 充足试次数（>50）
- 合适预处理
- 统计阈值

---

### 11.4 非平稳性

**问题：** 连接性随时间变化

**应对：**
- 滑窗分析
- 状态转换检测
- 时频连接性

---

## 12. 软件互操作

### 12.1 导出到其他工具

**BCT（Brain Connectivity Toolbox）：**
```matlab
% 导出邻接矩阵
adj_matrix = ConnMatrix;
save('connectivity.mat', 'adj_matrix');
```

**CONN工具箱：**
```matlab
% 导出为NIfTI
out_mri_nii(ConnMatrix, 'conn_matrix.nii');
```

---

## 13. 最佳实践

### 13.1 方法选择指南

| 研究问题 | 推荐方法 | 备注 |
|---------|---------|------|
| 静息态网络 | 相关/AEC | 低频，慢波 |
| 振荡耦合 | PLV/相干 | 频段特异性 |
| 信息流 | Granger/PTE | 因果推断 |
| 非线性 | 互信息/传递熵 | 计算密集 |
| 快速筛选 | 相关 | 简单稳健 |

---

### 13.2 报告清单

发表时应报告：
- [ ] 连接性测量类型
- [ ] 时间窗口/频段
- [ ] Scout定义方法
- [ ] Scout函数（mean/PCA）
- [ ] 是否正交化/去偏
- [ ] 统计校正方法
- [ ] 样本量（试次/被试）

---

## 14. 参考文献

1. Bastos & Schoffelen (2016). A tutorial review of functional connectivity analysis methods
2. Nolte et al. (2004). Identifying true brain interaction from EEG data using the imaginary part of coherence
3. Granger (1969). Investigating causal relations by econometric models
4. Hipp et al. (2012). Large-scale cortical correlation structure of spontaneous oscillatory activity
5. Vinck et al. (2011). An improved index of phase-synchronization for electrophysiological data
6. Colclough et al. (2015). How reliable are MEG resting-state connectivity metrics?
