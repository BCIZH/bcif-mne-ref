# Brainstorm3 时频分析算法详解

## 概述

时频分析揭示神经振荡活动的时变频域特性，是研究大脑节律（α、β、γ波等）的核心工具。Brainstorm3提供15+个时频分析函数。

## 1. Morlet小波分析 (process_timefreq.m)

### 1.1 算法原理

**Morlet小波定义：**
```matlab
ψ(t, f) = (πF_b²)^(-1/2) * exp(2iπft) * exp(-t²/F_b²)
```

其中：
- f: 中心频率
- F_b: 半高全宽时间常数（FWHM_tc）
- F_c: 中心频率归一化因子

**连续小波变换（CWT）：**
```matlab
TF(f, t) = ∫ x(τ) * ψ*(τ-t, f) dτ
```

离散实现：
```matlab
TF(f,:) = ifft(fft(x) .* conj(fft(ψ(f))))
```

---

### 1.2 参数配置

**关键参数：**

| 参数 | 符号 | 典型值 | 说明 |
|------|------|--------|------|
| Center frequency | $f_c$ | 1 | 归一化中心频率 |
| Time FWHM | $F_b$ | 3 | 时域半高全宽（秒） |
| Frequency resolution | Δf | - | 由$F_b$决定：Δf ≈ 1/F_b |

**频率-时间权衡：**
- **窄带小波**（大$F_b$）：高频率分辨率，低时间分辨率
- **宽带小波**（小$F_b$）：高时间分辨率，低频率分辨率

**自适应参数：**
```matlab
% 固定周期数（推荐）
num_cycles(f) = f / F_c  % 随频率增加
FWHM_t(f) = num_cycles(f) / f

% 固定FWHM
FWHM_t = 常数（所有频率）
```

---

### 1.3 使用示例

```matlab
% 基本Morlet小波
sFiles = bst_process('CallProcess', 'process_timefreq', sFiles, [], ...
    'sensortypes', 'MEG', ...
    'edit', struct(...
        'Method',       'morlet', ...
        'Freqs',        [1:1:40], ...       % 1-40 Hz
        'MorletFc',     1, ...              % 中心频率
        'MorletFwhmTc', 3, ...              % 时间常数
        'Output',       'power', ...        % 功率
        'Average',      0, ...              % 不平均试次
        'RemoveEvoked', 0));
```

**频段分析：**
```matlab
% Alpha频段 (8-12 Hz)
sFiles = bst_process('CallProcess', 'process_timefreq', sFiles, [], ...
    'edit', struct(...
        'Freqs',  [8:0.5:12], ...
        'MorletFwhmTc', 5));  % 更高频率分辨率
```

---

### 1.4 输出类型

**功率（Power）：**
```matlab
Power(f,t) = |TF(f,t)|²
```

**相位（Phase）：**
```matlab
Phase(f,t) = angle(TF(f,t))
```

**幅度（Magnitude）：**
```matlab
Magnitude(f,t) = |TF(f,t)|
```

---

## 2. Hilbert变换 (process_hilbert.m)

### 2.1 算法原理

**解析信号：**
```matlab
x_analytic(t) = x(t) + i*H{x}(t)
      = A(t) * exp(iφ(t))
```

其中：
- H{}: Hilbert变换算子
- A(t): 瞬时幅度
- φ(t): 瞬时相位

**频域实现：**
```matlab
X_analytic = fft(x)
X_analytic(1:N/2) *= 2
X_analytic(N/2+1:end) = 0
x_analytic = ifft(X_analytic)
```

---

### 2.2 使用场景

**1. 带通滤波 + Hilbert**

这是标准流程：

```matlab
% 定义频段
freq_bands = [8 12; 13 30; 30 80];  % Alpha, Beta, Gamma
band_names = {'alpha', 'beta', 'gamma'};

% 对每个频段
for i = 1:size(freq_bands, 1)
    % 1. 带通滤波
    sFiles_filt = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
        'highpass', freq_bands(i,1), ...
        'lowpass',  freq_bands(i,2));
    
    % 2. Hilbert变换
    sFiles_tf = bst_process('CallProcess', 'process_hilbert', sFiles_filt, [], ...
        'output', 'power');
end
```

**2. 包络提取（振幅调制）**

```matlab
% 提取低频包络（如α波幅度调制）
sFiles = bst_process('CallProcess', 'process_hilbert', sFiles, [], ...
    'bands', [8, 12], ...      % α频段
    'output', 'magnitude', ... % 幅度包络
    'mirror', 0);
```

---

### 2.3 优缺点

**优点：**
- ✓ 快速（FFT based）
- ✓ 单频段时间分辨率高
- ✓ 提供连续相位信息

**缺点：**
- ✗ 需要预先滤波
- ✗ 滤波器设计影响结果
- ✗ 不适合多频段同时分析

---

## 3. 短时傅里叶变换 (STFT, process_timefreq with 'stft')

### 3.1 算法原理

**加窗傅里叶变换：**
```matlab
STFT(f,t) = ∫ x(τ) * w(τ-t) * exp(-2iπfτ) dτ
```

其中：
- w(t): 窗函数（Hanning, Hamming等）
- 窗口长度决定时频分辨率

**离散实现：**
```matlab
% 滑动窗口
for t = 1:hop:nTime
    window_data = x(t:t+win_len) .* hanning(win_len);
    STFT(:,t) = fft(window_data);
end
```

---

### 3.2 参数选择

| 参数 | 说明 | 典型值 |
|------|------|--------|
| Window length | 窗口长度 | 1-2秒 |
| Window overlap | 窗口重叠 | 50% |
| Window type | 窗函数 | Hanning |

**不确定性原理：**
```
Δt * Δf >= 1/(4π)
```

---

## 4. 功率谱密度 (PSD, process_psd.m)

### 4.1 Welch方法

**算法步骤：**
1. 分段：将信号分成重叠段
2. 加窗：每段乘以窗函数
3. FFT：计算每段功率谱
4. 平均：对所有段平均

```matlab
function PSD = welch_psd(x, win_len, overlap, sfreq)
    nSegments = floor((length(x) - overlap) / (win_len - overlap));
    PSD = zeros(win_len/2+1, 1);
    
    for i = 1:nSegments
        seg = x((i-1)*(win_len-overlap)+1 : i*win_len);
        seg = seg .* hanning(win_len);
        Pseg = abs(fft(seg)).^2 / win_len;
        PSD = PSD + Pseg(1:win_len/2+1);
    end
    
    PSD = PSD / nSegments;  % 平均
end
```

---

### 4.2 使用示例

```matlab
% 计算PSD
sFiles = bst_process('CallProcess', 'process_psd', sFiles, [], ...
    'timewindow',  [], ...        % 全时段
    'win_length',  1, ...         % 1秒窗口
    'win_overlap', 50, ...        % 50%重叠
    'clusters',    {}, ...
    'scoutfunc',   1, ...         % Mean
    'edit', struct(...
        'Comment',    'Power', ...
        'TimeBands',  [], ...
        'Freqs',      [0, 150], ...
        'Output',     'power', ...
        'ClusterFuncTime', 'none'));
```

**参数规范频段：**
```matlab
% 计算频段功率
sFiles = bst_process('CallProcess', 'process_psd', sFiles, [], ...
    'edit', struct(...
        'TimeBands', {'delta', '2, 4'; ...
                      'theta', '5, 7'; ...
                      'alpha', '8, 12'; ...
                      'beta',  '13, 30'; ...
                      'gamma', '30, 100'}));
```

---

## 5. 多重taper方法 (Multitaper)

### 5.1 原理

使用多个正交taper窗口减少方差：

```matlab
% Slepian序列（DPSS）
[tapers, lambda] = dpss(N, NW, K);

% 对每个taper计算谱
for k = 1:K
    S_k = fft(x .* tapers(:,k));
    PSD = PSD + |S_k|^2;
end
PSD = PSD / K;
```

**参数：**
- NW: 时间-带宽积（典型值：3, 4）
- K: taper数量（典型：2*NW - 1）

---

## 6. 时频归一化

### 6.1 基线校正

**相对功率：**
```matlab
TF_norm(f,t) = (TF(f,t) - mean(TF_baseline(f,:))) / mean(TF_baseline(f,:))
```

**dB转换：**
```matlab
TF_dB(f,t) = 10 * log10(TF(f,t) / mean(TF_baseline(f,:)))
```

**Z-score：**
```matlab
TF_z(f,t) = (TF(f,t) - mean(TF_baseline(f,:))) / std(TF_baseline(f,:))
```

---

### 6.2 1/f校正（谱平坦化）

神经信号表现1/f特性，高频功率自然较低。

**乘以频率：**
```matlab
TF_flat(f,t) = f * TF(f,t)
```

**启用：**
```matlab
'normalize2020', 1  % 在process_timefreq中
```

---

## 7. 事件相关同步化/去同步化 (ERS/ERD)

### 7.1 定义

**ERD（事件相关去同步化）：**
功率相对基线下降

**ERS（事件相关同步化）：**
功率相对基线上升

### 7.2 计算

```matlab
% ERD/ERS百分比
ERD(f,t) = (TF(f,t) - TF_baseline(f)) / TF_baseline(f) * 100
```

---

## 8. 时频统计分析

### 8.1 非参数聚类置换检验

```matlab
% 1. 计算所有被试时频图
sFiles_tf = bst_process('CallProcess', 'process_timefreq', sFiles, []);

% 2. 组平均
sFiles_avg = bst_process('CallProcess', 'process_average', sFiles_tf, [], ...
    'avgtype',  1, ...  % 试次内
    'keepevents', 0);

% 3. 统计检验
sFiles_stat = bst_process('CallProcess', 'process_test_permutation2', ...
    sFiles_A, sFiles_B, [], ...
    'timewindow',     [], ...
    'scoutsel',       {}, ...
    'scoutfunc',      1, ...
    'isnorm',         0, ...
    'avgtime',        0, ...
    'avgfreq',        0, ...
    'randomizations', 1000, ...
    'tail',           'two');
```

---

## 9. 高级应用

### 9.1 相位幅度耦合 (PAC, process_pac_dynamic.m)

**测量低频相位调制高频幅度：**

```matlab
% 计算PAC
sFiles = bst_process('CallProcess', 'process_pac_dynamic', sFiles, [], ...
    'nesting',   [4, 8], ...   % 低频（相位）
    'nested',    [60, 150], ... % 高频（幅度）
    'measure',   'meanvect');   % 平均向量长度
```

**PAC测量：**
- **MI (Modulation Index)**: 互信息
- **MVL (Mean Vector Length)**: 平均向量长度
- **PLV (Phase-Locking Value)**: 相位锁定值

---

### 9.2 瞬时频率 (process_tf_instfreq.m)

从相位导数计算：

```matlab
f_inst(t) = 1/(2π) * dφ/dt
```

---

## 10. 实用场景

### 10.1 场景1：运动执行研究

**目标：** 检测运动准备期β波去同步化

```matlab
% 1. 导入数据并分段
sFiles = bst_process('CallProcess', 'process_import_data_event', ...);

% 2. 时频分析（β频段）
sFiles_tf = bst_process('CallProcess', 'process_timefreq', sFiles, [], ...
    'edit', struct(...
        'Freqs',  [13:1:30], ...     % β波段
        'MorletFwhmTc', 5));

% 3. 基线归一化
sFiles_norm = bst_process('CallProcess', 'process_baseline_norm', sFiles_tf, [], ...
    'baseline',  [-1, -0.5], ...     % 基线期
    'method',    'ersd', ...         % ERD/ERS百分比
    'overwrite', 1);

% 4. 可视化
% 预期：运动前β功率下降（ERD）
```

---

### 10.2 场景2：静息态频谱分析

**目标：** 计算各频段绝对功率

```matlab
% 1. 长时段数据导入
sFiles = bst_process('CallProcess', 'process_import_data_time', ...);

% 2. PSD计算
sFiles_psd = bst_process('CallProcess', 'process_psd', sFiles, [], ...
    'win_length',  4, ...      % 4秒窗口
    'win_overlap', 50, ...
    'edit', struct(...
        'TimeBands', {'alpha', '8, 13'; ...
                      'beta',  '13, 30'}));

% 3. 提取频段功率
% 用于：生物标志物、临床评估
```

---

### 10.3 场景3：听觉稳态反应 (ASSR)

**目标：** 检测40 Hz听觉刺激诱发反应

```matlab
% 1. 时频分析（窄频段）
sFiles_tf = bst_process('CallProcess', 'process_timefreq', sFiles, [], ...
    'edit', struct(...
        'Freqs',  [38:0.5:42], ...   % 40Hz附近高分辨率
        'MorletFwhmTc', 10));         % 窄频带

% 2. 平均试次
sFiles_avg = bst_process('CallProcess', 'process_average', sFiles_tf, []);

% 预期：40Hz处功率增强
```

---

## 11. 性能优化

### 11.1 内存管理

**大数据集策略：**
```matlab
% 1. 降采样
sFiles = bst_process('CallProcess', 'process_resample', sFiles, [], ...
    'freq', 250);  % 降到250Hz

% 2. 选择ROI通道
'sensortypes', 'MEG GRAD'

% 3. 时间窗口限制
'timewindow', [0, 1]
```

---

### 11.2 并行计算

```matlab
% 启用并行处理
sProcess.options.parallel.Value = 1;
```

---

## 12. 常见问题

**Q: Morlet vs Hilbert?**
A:
- Morlet: 多频段同时，频率连续
- Hilbert: 单频段，需预滤波，更快

**Q: 如何选择Morlet参数?**
A:
- 低频(<10Hz): FWHM_tc = 5-10（高频分辨率）
- 高频(>30Hz): FWHM_tc = 2-3（高时间分辨率）

**Q: 边缘效应?**
A: 时频分解在信号边缘不可靠，使用`TFmask`标记。

**Q: 相位可靠性?**
A: 需要足够SNR，考虑使用试次间相位一致性（ITPC）评估。

---

## 13. 质量控制

### 13.1 检查清单

- [ ] 频率范围覆盖感兴趣频段
- [ ] 时间窗口足够长（至少3个周期）
- [ ] 基线期选择合理
- [ ] 边缘效应掩码应用
- [ ] 试次数足够（>30）

---

## 14. 参考文献

1. Cohen, M. X. (2014). Analyzing Neural Time Series Data
2. Tallon-Baudry et al. (1996). Oscillatory gamma-band activity induced by a visual search task
3. Pfurtscheller & Lopes da Silva (1999). Event-related EEG/MEG synchronization and desynchronization
4. Canolty & Knight (2010). The functional role of cross-frequency coupling
